{
    "version": "https://jsonfeed.org/version/1",
    "title": "Will • All posts by \"ai\" category",
    "description": "愿你一生努力，一生被爱",
    "home_page_url": "https://github.com/yangxiangnanwill/yangxiangnanwill.github.io",
    "items": [
        {
            "id": "https://github.com/yangxiangnanwill/yangxiangnanwill.github.io/2026/01/04/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/AI/ClaudeCode%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93/",
            "url": "https://github.com/yangxiangnanwill/yangxiangnanwill.github.io/2026/01/04/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/AI/ClaudeCode%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93/",
            "title": "ClaudeCode实践总结",
            "date_published": "2026-01-04T07:24:49.995Z",
            "content_html": "<h2 id=\"CLAUDE-md：Agent-的行为准则\"><a href=\"#CLAUDE-md：Agent-的行为准则\" class=\"headerlink\" title=\"CLAUDE.md：Agent 的行为准则\"></a>CLAUDE.md：Agent 的行为准则</h2><p>在代码库里高效使用 Claude Code，最重要的文件就是根目录下的 <code>CLAUDE.md</code>。它是 Agent 的行为准则，是了解仓库运作方式的首要依据。</p>\n<h3 id=\"核心哲学\"><a href=\"#核心哲学\" class=\"headerlink\" title=\"核心哲学\"></a>核心哲学</h3><p>随着时间推移，我形成了一套鲜明且有主见的写作哲学来打造高效的 <code>CLAUDE.md</code>：</p>\n<table>\n<thead>\n<tr>\n<th>原则</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>先设限制，而非写指南</strong></td>\n<td>从小处着手，根据 Claude 常犯的错误逐步记录</td>\n</tr>\n<tr>\n<td><strong>别到处 @ 引用文档</strong></td>\n<td>提到路径即可，而非将整份文件塞进上下文窗口</td>\n</tr>\n<tr>\n<td><strong>不要只说”禁止”</strong></td>\n<td>提供可行替代方案，避免 Agent 左右脑互博</td>\n</tr>\n<tr>\n<td><strong>把 CLAUDE.md 当成强制性手段</strong></td>\n<td>用 bash 包装器替代长篇解释，迫使代码精简</td>\n</tr>\n</tbody></table>\n<h3 id=\"最佳实践示例\"><a href=\"#最佳实践示例\" class=\"headerlink\" title=\"最佳实践示例\"></a>最佳实践示例</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\"><span class=\"hljs-section\"># CLAUDE.md 开发准则</span><br><br><span class=\"hljs-section\">## 概览</span><br><br>本文件用于指导在当前仓库内进行的全部开发与文档工作。<br><br><span class=\"hljs-strong\">**上下文信息要求**</span><br><br><span class=\"hljs-bullet\">-</span> 在编码前至少分析 3 个现有实现或模式<br><span class=\"hljs-bullet\">-</span> 绘制依赖与集成点<br><span class=\"hljs-bullet\">-</span> 弄清测试框架和编码规范<br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**优先使用 context7 查询编程库文档**</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**使用 github.search<span class=\"hljs-emphasis\">_code 搜索开源实现示例**</span></span><br><span class=\"hljs-emphasis\"><span class=\"hljs-strong\">- **使用 desktop-commander 进行本地文件分析**</span></span><br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>核心要点</strong></p>\n<p>把 <code>CLAUDE.md</code> 当作一套<strong>高层次、精心策划的护栏和指引</strong>，而非无所不包的百科全书。</p>\n</blockquote>\n<hr>\n<h2 id=\"上下文管理：压缩与清理\"><a href=\"#上下文管理：压缩与清理\" class=\"headerlink\" title=\"上下文管理：压缩与清理\"></a>上下文管理：压缩与清理</h2><p>建议在编码会话中至少运行一次 <code>/context</code>，了解有限 token 的上下文窗口使用情况。以 Sonnet-1M 为例，基线成本约 20k token（10%），剩下 180k 用于实际修改。</p>\n<h3 id=\"三种工作流程对比\"><a href=\"#三种工作流程对比\" class=\"headerlink\" title=\"三种工作流程对比\"></a>三种工作流程对比</h3><table>\n<thead>\n<tr>\n<th>方式</th>\n<th>适用场景</th>\n<th>推荐度</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>&#x2F;compact</strong></td>\n<td>自动压缩上下文</td>\n<td>⭐ 不推荐</td>\n</tr>\n<tr>\n<td><strong>&#x2F;clear + 重启对话</strong></td>\n<td>简单重启场景</td>\n<td>✅ 默认选择</td>\n</tr>\n<tr>\n<td><strong>记录并清除</strong></td>\n<td>大型复杂任务</td>\n<td>✅ 复杂任务</td>\n</tr>\n</tbody></table>\n<h4 id=\"1-x2F-compact（避免使用）\"><a href=\"#1-x2F-compact（避免使用）\" class=\"headerlink\" title=\"1. &#x2F;compact（避免使用）\"></a>1. &#x2F;compact（避免使用）</h4><p>自动压缩过程不透明、容易出错，压缩完毕后幻觉更加严重。</p>\n<h4 id=\"2-x2F-clear-重启对话（默认方式）\"><a href=\"#2-x2F-clear-重启对话（默认方式）\" class=\"headerlink\" title=\"2. &#x2F;clear + 重启对话（默认方式）\"></a>2. &#x2F;clear + 重启对话（默认方式）</h4><p>清除状态后进行对话，让 Claude 读取当前 git 分支中所有已更改的文件。</p>\n<h4 id=\"3-“记录并清除”（复杂重启）\"><a href=\"#3-“记录并清除”（复杂重启）\" class=\"headerlink\" title=\"3. “记录并清除”（复杂重启）\"></a>3. “记录并清除”（复杂重启）</h4><p>用于大型任务：</p>\n<ol>\n<li>让 Claude 把计划和进展输出到 <code>.md</code> 文件</li>\n<li>用 <code>/clear</code> 清除上下文</li>\n<li>读取那个 <code>.md</code> 文件开始新会话继续工作</li>\n</ol>\n<blockquote>\n<p><strong>核心要点</strong></p>\n<p>不要相信自动压缩。对简单重启使用 <code>/clear</code>，对复杂任务使用”记录并清除”方法创建持久的外部”记忆”。</p>\n</blockquote>\n<hr>\n<h2 id=\"自定义斜杠命令\"><a href=\"#自定义斜杠命令\" class=\"headerlink\" title=\"自定义斜杠命令\"></a>自定义斜杠命令</h2><p>我把斜杠命令看作是常用提示的简单快捷方式，仅此而已。</p>\n<h3 id=\"我的精简配置\"><a href=\"#我的精简配置\" class=\"headerlink\" title=\"我的精简配置\"></a>我的精简配置</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\">/catchup : 读取当前 git 分支中所有已更改的文件<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"反模式警示\"><a href=\"#反模式警示\" class=\"headerlink\" title=\"反模式警示\"></a>反模式警示</h3><blockquote>\n<p>恕我直言，如果你有一长串复杂的自定义斜杠命令，你就制造了一个反模式。</p>\n</blockquote>\n<p>像 Claude 这样的 Agent 全部意义在于：输入<strong>几乎任何</strong>想要的东西，得到有用的、可合并的结果。一旦强迫用户学习需要查文档的魔法命令列表，你就失败了。</p>\n<blockquote>\n<p><strong>核心要点</strong></p>\n<p>把斜杠命令当作<strong>简单、个人化</strong>的快捷方式，而不是用它来替代构建更直观的 <code>CLAUDE.md</code>。</p>\n</blockquote>\n<hr>\n<h2 id=\"恢复、继续与历史记录\"><a href=\"#恢复、继续与历史记录\" class=\"headerlink\" title=\"恢复、继续与历史记录\"></a>恢复、继续与历史记录</h2><h3 id=\"基础用法\"><a href=\"#基础用法\" class=\"headerlink\" title=\"基础用法\"></a>基础用法</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">claude --resume    <span class=\"hljs-comment\"># 恢复会话</span><br>claude --<span class=\"hljs-built_in\">continue</span>  <span class=\"hljs-comment\"># 继续会话</span><br></code></pre></td></tr></table></figure>\n\n<p>对于重启出问题的终端或快速恢复旧会话非常好用。经常 <code>claude --resume</code> 几天前的会话，只为问 Agent 它是如何克服某个特定错误的。</p>\n<h3 id=\"进阶用法：元分析\"><a href=\"#进阶用法：元分析\" class=\"headerlink\" title=\"进阶用法：元分析\"></a>进阶用法：元分析</h3><p>Claude Code 将所有会话历史存储在 <code>~/.claude/projects/</code> 中。可以编写脚本对这些日志进行元分析，寻找常见异常、权限请求和错误模式。</p>\n<blockquote>\n<p><strong>核心要点</strong></p>\n<p>使用 <code>claude --resume</code> 和 <code>claude --continue</code> 来重启会话和挖掘历史上下文。无效会话可以清除。</p>\n</blockquote>\n<hr>\n<h2 id=\"Plan-模式\"><a href=\"#Plan-模式\" class=\"headerlink\" title=\"Plan 模式\"></a>Plan 模式</h2><p>对于任何使用 AI IDE 进行的”大型”功能变更，<strong>规划都是必不可少的</strong>。</p>\n<h3 id=\"实践价值\"><a href=\"#实践价值\" class=\"headerlink\" title=\"实践价值\"></a>实践价值</h3><figure class=\"highlight abnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs abnf\">Plan 模式 <span class=\"hljs-operator\">=</span> 与 Agent 对齐的方式<br>         <span class=\"hljs-operator\">=</span> 定义<span class=\"hljs-string\">&quot;如何&quot;</span>构建<br>         <span class=\"hljs-operator\">=</span> 定义检查点<br>         <span class=\"hljs-operator\">=</span> 培养提供最少上下文的直觉<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"工作流程\"><a href=\"#工作流程\" class=\"headerlink\" title=\"工作流程\"></a>工作流程</h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs\">需求理解 → Plan 模式生成文档 → 风暴讨论 → 模型协助澄清 → 审核确认 → 基于计划开发<br></code></pre></td></tr></table></figure>\n\n<p>这很考验对任务的理解和思考，以及提示词能力（表结构、实施方案等）。</p>\n<blockquote>\n<p><strong>核心要点</strong></p>\n<p>对于复杂的变更，<strong>总是</strong>使用内置的 Plan 模式，在 Agent 开始工作前就计划达成一致。</p>\n</blockquote>\n<hr>\n<h2 id=\"技能-Skills\"><a href=\"#技能-Skills\" class=\"headerlink\" title=\"技能 (Skills)\"></a>技能 (Skills)</h2><blockquote>\n<p><strong>Skills（也许）比 MCP 更重要，但Specs会把需求拆成”专业废纸”，实现全是屎。</strong></p>\n</blockquote>\n<h3 id=\"心智模型演变\"><a href=\"#心智模型演变\" class=\"headerlink\" title=\"心智模型演变\"></a>心智模型演变</h3><figure class=\"highlight nestedtext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nestedtext\"><span class=\"hljs-attribute\">┌─────────────────────────────────────────────────────────┐</span><br><span class=\"hljs-attribute\">│  阶段 1</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">单次提示 (Single Prompt)                        │</span><br><span class=\"hljs-attribute\">│          在巨大提示中给所有上下文（脆弱，无法扩展）       │</span><br><span class=\"hljs-attribute\">├─────────────────────────────────────────────────────────┤</span><br><span class=\"hljs-attribute\">│  阶段 2</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">工具调用 (Tool Calling)                        │</span><br><span class=\"hljs-attribute\">│          手动制作工具，为 Agent 抽象现实                 │</span><br><span class=\"hljs-attribute\">│          （更好，但创造了新的抽象和上下文瓶颈）          │</span><br><span class=\"hljs-attribute\">├─────────────────────────────────────────────────────────┤</span><br><span class=\"hljs-attribute\">│  阶段 3</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">脚本化 (Scripting) ★                           │</span><br>│          给 Agent 访问原始环境的权限                     │<br>│          动态编写代码与环境交互（健壮、灵活）            │<br>└─────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"为什么-Skills-是正确的抽象\"><a href=\"#为什么-Skills-是正确的抽象\" class=\"headerlink\" title=\"为什么 Skills 是正确的抽象\"></a>为什么 Skills 是正确的抽象</h3><p><strong>Agent Skills</strong> 将”脚本化”这一层正式产品化。如果你<strong>倾向于使用 CLI 而非 MCP</strong>，其实一直在不自觉地享受 Skills 好处。</p>\n<p><code>SKILL.md</code> 文件只是更有组织、可共享、可发现的方式来记录 CLI 和脚本，并将它们暴露给智能体。</p>\n<blockquote>\n<p><strong>核心要点</strong></p>\n<p>Skills 是正确的抽象。它们将基于”脚本化”的智能体模型正式化，这种模型比 MCP 所代表的僵硬 API 模型更健壮、更灵活。</p>\n</blockquote>\n<hr>\n<h2 id=\"模型上下文协议-MCP\"><a href=\"#模型上下文协议-MCP\" class=\"headerlink\" title=\"模型上下文协议 (MCP)\"></a>模型上下文协议 (MCP)</h2><h3 id=\"Skills-≠-MCP-已死\"><a href=\"#Skills-≠-MCP-已死\" class=\"headerlink\" title=\"Skills ≠ MCP 已死\"></a>Skills ≠ MCP 已死</h3><p>以前，许多人构建了糟糕的、上下文沉重的 MCP，包含几十个只是简单镜像 REST API 的工具。</p>\n<h3 id=\"新角色定位\"><a href=\"#新角色定位\" class=\"headerlink\" title=\"新角色定位\"></a>新角色定位</h3><p>MCP 应该是<strong>数据网关</strong>，提供几个强大的高层次工具：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs javascript\"><span class=\"hljs-comment\">// ✅ 好的 MCP 示例</span><br><span class=\"hljs-title function_\">download_raw_data</span>(filters…)           <span class=\"hljs-comment\">// 原始数据转储</span><br><span class=\"hljs-title function_\">take_sensitive_gated_action</span>(args…)    <span class=\"hljs-comment\">// 敏感操作</span><br><span class=\"hljs-title function_\">execute_code_in_environment_with_state</span>(code…) <span class=\"hljs-comment\">// 环境代码执行</span><br></code></pre></td></tr></table></figure>\n\n<p>在这个模型中，MCP 的工作是管理认证、网络和安全边界，然后让开。它为智能体提供<strong>入口点</strong>，然后智能体利用脚本能力完成实际工作。</p>\n<h3 id=\"我使用的-MCP\"><a href=\"#我使用的-MCP\" class=\"headerlink\" title=\"我使用的 MCP\"></a>我使用的 MCP</h3><table>\n<thead>\n<tr>\n<th>MCP</th>\n<th>用途</th>\n<th>推荐度</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Context7</strong></td>\n<td>文档搜索工具，提供最新库文档和代码示例</td>\n<td>⭐⭐⭐⭐⭐</td>\n</tr>\n<tr>\n<td><strong>server-sequential-thinking</strong></td>\n<td>规范式思考体系</td>\n<td>⭐⭐⭐⭐</td>\n</tr>\n<tr>\n<td><strong>server-memory</strong></td>\n<td>知识图谱记忆系统</td>\n<td>⭐⭐⭐</td>\n</tr>\n<tr>\n<td><strong>deepwiki</strong></td>\n<td>个人文档总结</td>\n<td>⭐⭐⭐</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p><strong>核心要点</strong></p>\n<p>使用扮演<strong>数据网关</strong>角色的 MCP。给智能体一两个高层次工具，然后让它基于这些工具编写脚本。</p>\n<p>给所有大模型加上联网功能，套到极致，就是艺术。</p>\n</blockquote>\n<hr>\n<h2 id=\"附录：CLAUDE-md-完整模板参考\"><a href=\"#附录：CLAUDE-md-完整模板参考\" class=\"headerlink\" title=\"附录：CLAUDE.md 完整模板参考\"></a>附录：CLAUDE.md 完整模板参考</h2><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\"><span class=\"hljs-section\"># CLAUDE.md 开发准则</span><br><br><span class=\"hljs-section\">## 概览</span><br><br>本文件用于指导在当前仓库内进行的全部开发与文档工作，确保输出遵循强制性标准并保持可审计性。<br><br><span class=\"hljs-section\">## 🔒 强制验证机制</span><br><br><span class=\"hljs-bullet\">-</span> 必须拒绝一切 CI、远程流水线或人工外包验证<br><span class=\"hljs-bullet\">-</span> 每次改动必须提供可重复的本地验证步骤<br><span class=\"hljs-bullet\">-</span> 验证过程中如遇工具缺失或测试覆盖不足，必须在任务文档中记录<br><br><span class=\"hljs-section\">## 📋 文件结构规范</span><br><br></code></pre></td></tr></table></figure>\n<p>.claude&#x2F;<br>├── context-summary-[任务名].md   ← 上下文摘要<br>├── operations-log.md             ← 决策和操作记录<br>└── verification-report.md        ← 验证报告</p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\"><br><span class=\"hljs-section\">## 🔄 标准工作流 6 步骤</span><br><br><span class=\"hljs-bullet\">1.</span> 分析需求<br><span class=\"hljs-bullet\">2.</span> 获取上下文<br><span class=\"hljs-bullet\">3.</span> 选择工具<br><span class=\"hljs-bullet\">4.</span> 执行任务<br><span class=\"hljs-bullet\">5.</span> 验证质量<br><span class=\"hljs-bullet\">6.</span> 存储知识<br><br><span class=\"hljs-section\">## 💡 开发哲学</span><br><br><span class=\"hljs-bullet\">-</span> 必须坚持渐进式迭代，保持每次改动可编译、可验证<br><span class=\"hljs-bullet\">-</span> 必须在实现前研读既有代码或文档<br><span class=\"hljs-bullet\">-</span> 必须保持务实态度，优先满足真实需求<br><span class=\"hljs-bullet\">-</span> 必须选择表达清晰的实现，拒绝炫技式写法<br><span class=\"hljs-bullet\">-</span> 必须偏向简单方案，避免过度架构<br></code></pre></td></tr></table></figure>\n\n<hr>\n<blockquote>\n<p><strong>最后提醒</strong></p>\n<p>将 <code>CLAUDE.md</code> 与 <code>AGENTS.md</code> 文件保持同步，以确保与其他 AI IDE 兼容。</p>\n</blockquote>\n<hr>\n<h2 id=\"安全章节\"><a href=\"#安全章节\" class=\"headerlink\" title=\"安全章节\"></a>安全章节</h2><p>在使用 Claude Code 的过程中，安全风险往往是容易被忽视的一环。以下是基于实践总结的安全红线与防护策略。</p>\n<h3 id=\"MCP-安全红线\"><a href=\"#MCP-安全红线\" class=\"headerlink\" title=\"MCP 安全红线\"></a>MCP 安全红线</h3><table>\n<thead>\n<tr>\n<th>风险类型</th>\n<th>风险描述</th>\n<th>防护策略</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>敏感操作</strong></td>\n<td>数据库删除、文件系统修改、API 密钥泄露</td>\n<td>必须二次确认、设置操作白名单</td>\n</tr>\n<tr>\n<td><strong>网络访问</strong></td>\n<td>任意 HTTP 请求、内网渗透风险</td>\n<td>限制可访问域名、记录所有请求</td>\n</tr>\n<tr>\n<td><strong>文件系统</strong></td>\n<td>完整目录读写权限、配置文件泄露</td>\n<td>设置 <code>.claudeignore</code> 排除敏感文件</td>\n</tr>\n<tr>\n<td><strong>会话劫持</strong></td>\n<td>长期会话未清理、权限继承风险</td>\n<td>定期清理无用会话、最小权限原则</td>\n</tr>\n</tbody></table>\n<h3 id=\"真实案例：危险配置-vs-安全配置\"><a href=\"#真实案例：危险配置-vs-安全配置\" class=\"headerlink\" title=\"真实案例：危险配置 vs 安全配置\"></a>真实案例：危险配置 vs 安全配置</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\">&lt;!-- ❌ 危险配置示例 --&gt;<br><span class=\"hljs-section\"># server-dangerous-mcp/server.py</span><br><span class=\"hljs-section\"># 问题：提供完整 shell 执行权限，无任何限制</span><br>def execute<span class=\"hljs-emphasis\">_command(args):</span><br><span class=\"hljs-emphasis\">    import subprocess</span><br><span class=\"hljs-emphasis\">    return subprocess.run(args, shell=True, capture_</span>output=True)<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\">&lt;!-- ✅ 安全配置示例 --&gt;<br><span class=\"hljs-section\"># server-safe-mcp/server.py</span><br><span class=\"hljs-section\"># 改进：白名单限制、可审计日志、隔离执行环境</span><br>ALLOWED<span class=\"hljs-emphasis\">_COMMANDS = &#123;</span><br><span class=\"hljs-emphasis\">    &#x27;git&#x27;: [&#x27;status&#x27;, &#x27;log&#x27;, &#x27;diff&#x27;],</span><br><span class=\"hljs-emphasis\">    &#x27;npm&#x27;: [&#x27;install&#x27;, &#x27;run&#x27;, &#x27;test&#x27;]</span><br><span class=\"hljs-emphasis\">&#125;</span><br><span class=\"hljs-emphasis\"></span><br><span class=\"hljs-emphasis\">def execute_</span>command(command, args):<br><span class=\"hljs-code\">    if command not in ALLOWED_COMMANDS:</span><br><span class=\"hljs-code\">        raise SecurityError(f&quot;命令 &#123;command&#125; 未授权&quot;)</span><br><span class=\"hljs-code\"></span><br><span class=\"hljs-code\">    if args and any(a not in ALLOWED_COMMANDS[command] for a in args):</span><br><span class=\"hljs-code\">        raise SecurityError(f&quot;参数 &#123;args&#125; 未授权&quot;)</span><br><span class=\"hljs-code\"></span><br><span class=\"hljs-code\">    # 记录操作日志</span><br><span class=\"hljs-code\">    audit_log.info(f&quot;已授权命令: &#123;command&#125; &#123;args&#125;&quot;)</span><br><span class=\"hljs-code\"></span><br><span class=\"hljs-code\">    # 在隔离环境中执行</span><br><span class=\"hljs-code\">    return subprocess.run(</span><br><span class=\"hljs-code\">        [command] + args,</span><br><span class=\"hljs-code\">        capture_output=True,</span><br><span class=\"hljs-code\">        timeout=30,</span><br><span class=\"hljs-code\">        cwd=&#x27;/sandbox/path&#x27;  # 限制工作目录</span><br><span class=\"hljs-code\">    )</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"CLAUDE-md-安全配置示例\"><a href=\"#CLAUDE-md-安全配置示例\" class=\"headerlink\" title=\"CLAUDE.md 安全配置示例\"></a>CLAUDE.md 安全配置示例</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\"><span class=\"hljs-section\">## ⚠️ 安全红线</span><br><br><span class=\"hljs-strong\">**绝对禁止：**</span><br><br><span class=\"hljs-bullet\">-</span> 在任何情况下执行 <span class=\"hljs-code\">`rm -rf /`</span> 或类似危险命令<br><span class=\"hljs-bullet\">-</span> 读取或输出 .env、<span class=\"hljs-emphasis\">*.pem、*</span>.key 等敏感文件内容<br><span class=\"hljs-bullet\">-</span> 调用未经审计的第三方 MCP<br><span class=\"hljs-bullet\">-</span> 在代码中硬编码 API Key、密码或 Token<br><br><span class=\"hljs-strong\">**必须遵守：**</span><br><br><span class=\"hljs-bullet\">-</span> 所有涉及生产环境的操作必须经过人工确认<br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-code\">`.claudeignore`</span> 中必须排除：.env、secrets/、<span class=\"hljs-strong\">**/<span class=\"hljs-emphasis\">*.pem</span></span><br><span class=\"hljs-emphasis\"><span class=\"hljs-strong\">- 使用环境变量替代硬编码凭据</span></span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"敏感操作二次确认机制\"><a href=\"#敏感操作二次确认机制\" class=\"headerlink\" title=\"敏感操作二次确认机制\"></a>敏感操作二次确认机制</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 实践：危险操作前设置防护网</span><br><span class=\"hljs-comment\"># 在 CLAUDE.md 中定义危险操作黑名单</span><br><br><span class=\"hljs-comment\">## 🚨 危险操作清单（需要二次确认）</span><br><br>以下操作类型在执行前必须停止并请求人工确认：<br><br>| 操作类型 | 危险等级 | 替代方案 |<br>|----------|----------|----------|<br>| `<span class=\"hljs-built_in\">rm</span> -rf` 或 `del /s` | 🔴 致命 | 使用安全删除脚本 |<br>| `DROP TABLE` | 🔴 致命 | 提供备份脚本 |<br>| `<span class=\"hljs-built_in\">chmod</span> 777` | 🟠 高 | 使用最小权限原则 |<br>| `git push --force` | 🟠 高 | 使用 `--force-with-lease` |<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>核心要点</strong></p>\n<p>安全不是事后补救，而是设计阶段就需要考虑的因素。给 Agent 的权限越小，越安全。</p>\n</blockquote>\n<hr>\n<h2 id=\"CLAUDE-md-反模式集合\"><a href=\"#CLAUDE-md-反模式集合\" class=\"headerlink\" title=\"CLAUDE.md 反模式集合\"></a>CLAUDE.md 反模式集合</h2><p>以下是实践中总结的常见反模式，以及对应的正确写法。</p>\n<h3 id=\"反模式-1：纯负面约束\"><a href=\"#反模式-1：纯负面约束\" class=\"headerlink\" title=\"反模式 #1：纯负面约束\"></a>反模式 #1：纯负面约束</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\">&lt;!-- ❌ 反模式：只说「禁止」 --&gt;<br><span class=\"hljs-section\">## 禁止事项</span><br><span class=\"hljs-bullet\">-</span> 绝对不要使用 --force 标志<br><span class=\"hljs-bullet\">-</span> 不要修改生产环境<br><span class=\"hljs-bullet\">-</span> 禁止使用 git reset<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\">&lt;!-- ✅ 正确写法：提供可行替代方案 --&gt;<br><span class=\"hljs-section\">## 操作规范</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**安全更新**</span>：使用 <span class=\"hljs-code\">`--interactive`</span> 或 <span class=\"hljs-code\">`--preview`</span> 进行预览<br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**生产环境修改**</span>：必须通过 PR 流程，单人不得直接操作<br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**版本回滚**</span>：使用 <span class=\"hljs-code\">`git revert`</span> 替代 <span class=\"hljs-code\">`git reset`</span>，保留历史可追溯<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"反模式-2：过度引用文档\"><a href=\"#反模式-2：过度引用文档\" class=\"headerlink\" title=\"反模式 #2：过度引用文档\"></a>反模式 #2：过度引用文档</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\">&lt;!-- ❌ 反模式：到处 @ 引用文档 --&gt;<br><span class=\"hljs-section\">## 参考资料</span><br>@./docs/api.md<br>@./docs/database.md<br>@./docs/architecture.md<br>@./docs/deployment.md<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\">&lt;!-- ✅ 正确写法：精准引用 + 场景说明 --&gt;<br><span class=\"hljs-section\">## 遇到以下情况时查阅文档</span><br><br>| 场景 | 文档位置 | 关注重点 |<br>|------|----------|----------|<br>| API 响应格式问题 | <span class=\"hljs-code\">`docs/api.md#errors`</span> | 错误码对照表 |<br>| 数据库迁移失败 | <span class=\"hljs-code\">`docs/db.md#migration`</span> | 回滚步骤 |<br>| 部署配置问题 | <span class=\"hljs-code\">`docs/deploy.md#production`</span> | 环境变量清单 |<br>| 遇到 FooBarError | <span class=\"hljs-code\">`docs/troubleshooting.md`</span> | 最佳排查步骤 |<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"反模式-3：模糊的约束\"><a href=\"#反模式-3：模糊的约束\" class=\"headerlink\" title=\"反模式 #3：模糊的约束\"></a>反模式 #3：模糊的约束</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\">&lt;!-- ❌ 反模式：语义不清，Agent 难以判断 --&gt;<br><span class=\"hljs-section\">## 编码规范</span><br><span class=\"hljs-bullet\">-</span> 代码要整洁<br><span class=\"hljs-bullet\">-</span> 遵循最佳实践<br><span class=\"hljs-bullet\">-</span> 注意性能问题<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\">&lt;!-- ✅ 正确写法：具体可执行 --&gt;<br><span class=\"hljs-section\">## 编码规范</span><br><br><span class=\"hljs-strong\">**代码风格（强制执行）：**</span><br><span class=\"hljs-bullet\">-</span> 使用 2 空格缩进<br><span class=\"hljs-bullet\">-</span> 使用单引号而非双引号<br><span class=\"hljs-bullet\">-</span> 每行最多 120 字符<br><br><span class=\"hljs-strong\">**性能要求：**</span><br><span class=\"hljs-bullet\">-</span> 循环内禁止同步网络请求<br><span class=\"hljs-bullet\">-</span> 批量操作必须使用事务<br><span class=\"hljs-bullet\">-</span> 任何 DB 查询必须有索引支持<br><br><span class=\"hljs-strong\">**代码质量门槛：**</span><br><span class=\"hljs-bullet\">-</span> 圈复杂度 &gt; 10 的函数必须拆分<br><span class=\"hljs-bullet\">-</span> 重复代码 &gt; 3 次必须抽象<br><span class=\"hljs-bullet\">-</span> 测试覆盖率必须 &gt; 80%<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"反模式-4：过度复杂的斜杠命令\"><a href=\"#反模式-4：过度复杂的斜杠命令\" class=\"headerlink\" title=\"反模式 #4：过度复杂的斜杠命令\"></a>反模式 #4：过度复杂的斜杠命令</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\">&lt;!-- ❌ 反模式：长串需要学习的命令 --&gt;<br><span class=\"hljs-section\"># claude<span class=\"hljs-emphasis\">_commands.json</span></span><br><span class=\"hljs-emphasis\"><span class=\"hljs-section\">&#123;</span></span><br><span class=\"hljs-emphasis\"><span class=\"hljs-section\">  &quot;/deploy-staging&quot;: &quot;1. 切换分支 2. 运行测试 3. 构建镜像 4. 推送 Staging&quot;,</span></span><br><span class=\"hljs-emphasis\"><span class=\"hljs-section\">  &quot;/deploy-production&quot;: &quot;1. 创建 PR 2. 代码审查 3. 合并主分支 4. CI/CD 等待 5. 健康检查&quot;,</span></span><br><span class=\"hljs-emphasis\"><span class=\"hljs-section\">  &quot;/rollback&quot;: &quot;1. 确认回滚版本 2. 执行回滚 3. 验证功能 4. 通知团队&quot;</span></span><br><span class=\"hljs-emphasis\"><span class=\"hljs-section\">&#125;</span></span><br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\">&lt;!-- ✅ 正确写法：只保留最常用的快捷方式 --&gt;<br><span class=\"hljs-section\"># 我的斜杠命令配置（仅 2 个）</span><br><br>| 命令 | 功能 | 使用场景 |<br>|------|------|----------|<br>| <span class=\"hljs-code\">`/catchup`</span> | 读取当前分支所有更改 | 接手新任务时 |<br>| <span class=\"hljs-code\">`/test`</span> | 运行单元测试并输出结果 | 代码提交前 |<br><br><span class=\"hljs-strong\">**原则**</span>：任何需要查文档才能记住的命令，都是失败的设计。<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"反模式-5：缺少上下文化说明\"><a href=\"#反模式-5：缺少上下文化说明\" class=\"headerlink\" title=\"反模式 #5：缺少上下文化说明\"></a>反模式 #5：缺少上下文化说明</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\">&lt;!-- ❌ 反模式：只说「要什么」，不说「为什么」 --&gt;<br><span class=\"hljs-section\">## 代码规范</span><br><span class=\"hljs-bullet\">-</span> 使用 TypeScript<br><span class=\"hljs-bullet\">-</span> 使用 React Hooks<br><span class=\"hljs-bullet\">-</span> 使用 Styled Components<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\">&lt;!-- ✅ 正确写法：上下文 + 理由 --&gt;<br><span class=\"hljs-section\">## 代码规范</span><br><br><span class=\"hljs-strong\">**技术栈选择：**</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**TypeScript**</span>：项目从 2023 年起全面采用，提供类型安全<br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**React Hooks**</span>：函数式组件优先，类组件仅在必要时使用（见 <span class=\"hljs-code\">`docs/legacy-react.md`</span>）<br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**Styled Components**</span>：保持元件样式封装，避免全局污染<br><br><span class=\"hljs-strong\">**为什么：**</span><br><span class=\"hljs-bullet\">-</span> TypeScript 减少了 60% 的运行时错误<br><span class=\"hljs-bullet\">-</span> Hooks 使逻辑复用更简单<br><span class=\"hljs-bullet\">-</span> Scoped Styles 避免了样式冲突<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>核心要点</strong></p>\n<p>好的 CLAUDE.md 应该是<strong>具体的、可执行的、有上下文的</strong>，而非模糊的道德规范或无所不包的百科全书。</p>\n</blockquote>\n<hr>\n<h2 id=\"实践检查清单\"><a href=\"#实践检查清单\" class=\"headerlink\" title=\"实践检查清单\"></a>实践检查清单</h2><p>以下是开始任何开发工作前，应该执行的检查清单。</p>\n<h3 id=\"会话开始前检查\"><a href=\"#会话开始前检查\" class=\"headerlink\" title=\"会话开始前检查\"></a>会话开始前检查</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\"><span class=\"hljs-section\">## 会话开始前检查清单</span><br><br><span class=\"hljs-section\">### 1. 环境检查</span><br><span class=\"hljs-bullet\">-</span> [ ] 确认当前 git 分支正确<br><span class=\"hljs-bullet\">-</span> [ ] 确认没有未提交的紧急变更<br><span class=\"hljs-bullet\">-</span> [ ] 确认 .claudeignore 已配置<br><span class=\"hljs-bullet\">-</span> [ ] 确认目标 MCP 已启动并正常<br><br><span class=\"hljs-section\">### 2. 上下文检查</span><br><span class=\"hljs-bullet\">-</span> [ ] 运行 <span class=\"hljs-code\">`/context`</span> 了解当前 token 使用情况<br><span class=\"hljs-bullet\">-</span> [ ] 检查是否有残留的 <span class=\"hljs-code\">`.claude/session-*`</span> 需要清理<br><span class=\"hljs-bullet\">-</span> [ ] 确认 CLAUDE.md 是否需要更新（新仓库）<br><br><span class=\"hljs-section\">### 3. 任务确认</span><br><span class=\"hljs-bullet\">-</span> [ ] 清楚理解任务目标和验收标准<br><span class=\"hljs-bullet\">-</span> [ ] 识别任务复杂度（简单/中等/复杂）<br><span class=\"hljs-bullet\">-</span> [ ] 规划是否需要使用 Plan 模式<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"编码前检查\"><a href=\"#编码前检查\" class=\"headerlink\" title=\"编码前检查\"></a>编码前检查</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\"><span class=\"hljs-section\">## 编码前检查清单</span><br><br><span class=\"hljs-section\">### 1. 上下文收集（强制）</span><br><span class=\"hljs-bullet\">-</span> [ ] 执行文件名搜索，找到 5-10 个候选文件<br><span class=\"hljs-bullet\">-</span> [ ] 执行内容搜索，找到关键实现位置<br><span class=\"hljs-bullet\">-</span> [ ] 深度阅读至少 3 个相似实现<br><span class=\"hljs-bullet\">-</span> [ ] 生成 <span class=\"hljs-code\">`.claude/context-summary-[任务名].md`</span><br><br><span class=\"hljs-section\">### 2. 充分性验证</span><br><span class=\"hljs-bullet\">-</span> [ ] 能说出至少 3 个相似实现的文件路径吗？<br><span class=\"hljs-bullet\">-</span> [ ] 理解项目的实现模式吗？<br><span class=\"hljs-bullet\">-</span> [ ] 知道有哪些可复用的工具函数吗？<br><span class=\"hljs-bullet\">-</span> [ ] 理解项目的命名约定和代码风格吗？<br><span class=\"hljs-bullet\">-</span> [ ] 知道如何测试这个功能吗？<br><span class=\"hljs-bullet\">-</span> [ ] 确认没有重复造轮子吗？<br><span class=\"hljs-bullet\">-</span> [ ] 理解这个功能的依赖和集成点吗？<br><br><span class=\"hljs-section\">### 3. 设计确认</span><br><span class=\"hljs-bullet\">-</span> [ ] 接口规格已定义<br><span class=\"hljs-bullet\">-</span> [ ] 边界条件已识别<br><span class=\"hljs-bullet\">-</span> [ ] 性能要求已明确<br><span class=\"hljs-bullet\">-</span> [ ] 测试标准已制定<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"代码提交前检查\"><a href=\"#代码提交前检查\" class=\"headerlink\" title=\"代码提交前检查\"></a>代码提交前检查</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\"><span class=\"hljs-section\">## 代码提交前检查清单</span><br><br><span class=\"hljs-section\">### 1. 代码质量</span><br><span class=\"hljs-bullet\">-</span> [ ] 所有自动化测试通过<br><span class=\"hljs-bullet\">-</span> [ ] 类型检查通过（TypeScript）<br><span class=\"hljs-bullet\">-</span> [ ] 格式化检查通过（Prettier/ESLint）<br><span class=\"hljs-bullet\">-</span> [ ] 没有 TODO 注释遗留<br><br><span class=\"hljs-section\">### 2. 上下文记录</span><br><span class=\"hljs-bullet\">-</span> [ ] 更新 <span class=\"hljs-code\">`operations-log.md`</span><br><span class=\"hljs-bullet\">-</span> [ ] 验证报告已生成（<span class=\"hljs-code\">`.claude/verification-report.md`</span>）<br><span class=\"hljs-bullet\">-</span> [ ] 复用了既有组件<br><span class=\"hljs-bullet\">-</span> [ ] 遵循了项目约定<br><br><span class=\"hljs-section\">### 3. 安全检查</span><br><span class=\"hljs-bullet\">-</span> [ ] 没有硬编码的 API Key 或密码<br><span class=\"hljs-bullet\">-</span> [ ] 敏感操作已记录日志<br><span class=\"hljs-bullet\">-</span> [ ] 没有绕过 .claudeignore 读取敏感文件<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>核心要点</strong></p>\n<p>检查清单不是负担，而是<strong>避免低级错误</strong>的最后一道防线。</p>\n</blockquote>\n<hr>\n<h2 id=\"决策框架\"><a href=\"#决策框架\" class=\"headerlink\" title=\"决策框架\"></a>决策框架</h2><p>在日常使用中，我们经常面临各种选择。以下框架可以帮助做出更好的决策。</p>\n<h3 id=\"1-会话重启决策树\"><a href=\"#1-会话重启决策树\" class=\"headerlink\" title=\"1. 会话重启决策树\"></a>1. 会话重启决策树</h3><figure class=\"highlight mel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mel\">开始会话<br>    │<br>    ├─ 上下文 &lt; <span class=\"hljs-number\">50</span>%<br>    │     └─ 继续当前对话<br>    │<br>    ├─ 上下文 <span class=\"hljs-number\">50</span><span class=\"hljs-number\">-70</span>%，任务简单<br>    │     └─ /<span class=\"hljs-keyword\">clear</span> + 继续对话<br>    │<br>    ├─ 上下文 <span class=\"hljs-number\">50</span><span class=\"hljs-number\">-70</span>%，任务复杂<br>    │     └─ 记录并清除 → 读取 .md 继续<br>    │<br>    └─ 上下文 &gt; <span class=\"hljs-number\">70</span>%，或出现幻觉<br>          └─ 立即 /<span class=\"hljs-keyword\">clear</span> + 重新开始<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"2-MCP-引入决策矩阵\"><a href=\"#2-MCP-引入决策矩阵\" class=\"headerlink\" title=\"2. MCP 引入决策矩阵\"></a>2. MCP 引入决策矩阵</h3><table>\n<thead>\n<tr>\n<th>问题</th>\n<th>MCP 解决？</th>\n<th>自建 MCP？</th>\n<th>CLI&#x2F;Skills？</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>需要访问外部 API</td>\n<td>✅ 是</td>\n<td>⚠️ 评估</td>\n<td>❌ 不适用</td>\n</tr>\n<tr>\n<td>需要执行敏感操作</td>\n<td>⚠️ 谨慎</td>\n<td>✅ 是</td>\n<td>❌ 不适用</td>\n</tr>\n<tr>\n<td>只是一次性查询</td>\n<td>❌ 否</td>\n<td>❌ 否</td>\n<td>✅ 是</td>\n</tr>\n<tr>\n<td>需要环境状态持久化</td>\n<td>⚠️ 复杂</td>\n<td>✅ 是</td>\n<td>❌ 否</td>\n</tr>\n<tr>\n<td>简单的数据转换</td>\n<td>❌ 否</td>\n<td>❌ 否</td>\n<td>✅ 是</td>\n</tr>\n</tbody></table>\n<h3 id=\"3-Plan-模式使用决策\"><a href=\"#3-Plan-模式使用决策\" class=\"headerlink\" title=\"3. Plan 模式使用决策\"></a>3. Plan 模式使用决策</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\"><span class=\"hljs-section\">## 什么时候使用 Plan 模式？</span><br><br><span class=\"hljs-section\">### 必须使用（复杂变更）</span><br><span class=\"hljs-bullet\">-</span> 新功能涉及 3 个以上模块<br><span class=\"hljs-bullet\">-</span> 数据库 schema 变更<br><span class=\"hljs-bullet\">-</span> API 破坏性变更<br><span class=\"hljs-bullet\">-</span> 涉及安全或权限修改<br><span class=\"hljs-bullet\">-</span> 团队协作项目<br><br><span class=\"hljs-section\">### 可选使用（中等复杂度）</span><br><span class=\"hljs-bullet\">-</span> 单模块重构<br><span class=\"hljs-bullet\">-</span> 新增 1-2 个 API 端点<br><span class=\"hljs-bullet\">-</span> 样式或 UI 调整<br><span class=\"hljs-bullet\">-</span> 文档结构变更<br><br><span class=\"hljs-section\">### 不需要（简单任务）</span><br><span class=\"hljs-bullet\">-</span> 修复明确的 bug<br><span class=\"hljs-bullet\">-</span> 添加单一测试用例<br><span class=\"hljs-bullet\">-</span> 更新文档错别字<br><span class=\"hljs-bullet\">-</span> 简单的配置调整<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"4-上下文收集深度决策\"><a href=\"#4-上下文收集深度决策\" class=\"headerlink\" title=\"4. 上下文收集深度决策\"></a>4. 上下文收集深度决策</h3><table>\n<thead>\n<tr>\n<th>任务复杂度</th>\n<th>搜索范围</th>\n<th>阅读数量</th>\n<th>深度</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>简单</strong>（单文件、&lt;50 行）</td>\n<td>本目录</td>\n<td>1-2 个</td>\n<td>浅</td>\n</tr>\n<tr>\n<td><strong>中等</strong>（多文件、&lt;200 行）</td>\n<td>整个 src</td>\n<td>3-5 个</td>\n<td>中</td>\n</tr>\n<tr>\n<td><strong>复杂</strong>（架构级、&gt;200 行）</td>\n<td>跨目录 + 外部</td>\n<td>5+ 个</td>\n<td>深</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p><strong>核心要点</strong></p>\n<p>决策框架的价值不在于给出标准答案，而在于<strong>避免在选择上浪费过多认知资源</strong>。</p>\n</blockquote>\n<hr>\n<h2 id=\"常见问题解决方案\"><a href=\"#常见问题解决方案\" class=\"headerlink\" title=\"常见问题解决方案\"></a>常见问题解决方案</h2><h3 id=\"Q1：Agent-无视-CLAUDE-md-约束\"><a href=\"#Q1：Agent-无视-CLAUDE-md-约束\" class=\"headerlink\" title=\"Q1：Agent 无视 CLAUDE.md 约束\"></a>Q1：Agent 无视 CLAUDE.md 约束</h3><p><strong>症状</strong>：明确写了「不要使用某种方式」，但 Agent 仍然使用。</p>\n<p><strong>原因分析</strong>：</p>\n<ul>\n<li>约束语义不清，Agent 理解错误</li>\n<li>没有提供替代方案</li>\n<li>约束与其他规则冲突</li>\n</ul>\n<p><strong>解决方案</strong>：</p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\">&lt;!-- ❌ 问题配置 --&gt;<br><span class=\"hljs-section\">## 约束</span><br><span class=\"hljs-bullet\">-</span> 不要使用 shell=True<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\">&lt;!-- ✅ 解决方案配置 --&gt;<br><span class=\"hljs-section\">## 约束</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**网络请求**</span>：使用 <span class=\"hljs-code\">`requests`</span> 库而非 shell 命令<br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**文件操作**</span>：使用 Python 的 <span class=\"hljs-code\">`pathlib`</span> 而非 <span class=\"hljs-code\">`os.system`</span><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**任何子进程**</span>：必须指定 <span class=\"hljs-code\">`shell=False`</span>，禁止使用 shell 注入<br></code></pre></td></tr></table></figure>\n\n<p><strong>验证方法</strong>：观察 Agent 连续 3 次任务后是否遵守。</p>\n<hr>\n<h3 id=\"Q2：上下文窗口爆炸\"><a href=\"#Q2：上下文窗口爆炸\" class=\"headerlink\" title=\"Q2：上下文窗口爆炸\"></a>Q2：上下文窗口爆炸</h3><p><strong>症状</strong>：对话进行到一半，Agent 开始产生幻觉或忘记之前的约束。</p>\n<p><strong>原因分析</strong>：</p>\n<ul>\n<li>读取了过多文件到上下文</li>\n<li>历史对话记录累积</li>\n<li>没有定期清理</li>\n</ul>\n<p><strong>解决方案</strong>：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 1. 定期检查上下文使用</span><br>/context<br><br><span class=\"hljs-comment\"># 2. 使用 .claudeignore 排除干扰文件</span><br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;node_modules/&quot;</span> &gt;&gt; .claudeignore<br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;*.log&quot;</span> &gt;&gt; .claudeignore<br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;dist/&quot;</span> &gt;&gt; .claudeignore<br><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;.git/&quot;</span> &gt;&gt; .claudeignore<br><br><span class=\"hljs-comment\"># 3. 会话中定期执行</span><br>/clear  <span class=\"hljs-comment\"># 重置上下文，继续当前任务</span><br></code></pre></td></tr></table></figure>\n\n<p><strong>预防策略</strong>：</p>\n<ul>\n<li>不要一次性让 Agent 读取整个项目</li>\n<li>使用 <code>.claudeignore</code> 排除 node_modules、dist、.git 等</li>\n<li>每完成一个子任务，主动 <code>/clear</code></li>\n</ul>\n<hr>\n<h3 id=\"Q3：MCP-权限过大\"><a href=\"#Q3：MCP-权限过大\" class=\"headerlink\" title=\"Q3：MCP 权限过大\"></a>Q3：MCP 权限过大</h3><p><strong>症状</strong>：Agent 使用 MCP 执行了预期外的操作（如删除文件、发送请求）。</p>\n<p><strong>原因分析</strong>：</p>\n<ul>\n<li>MCP 配置时没有设置权限限制</li>\n<li>没有二次确认机制</li>\n<li>缺少操作日志</li>\n</ul>\n<p><strong>解决方案</strong>：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-comment\"># MCP 服务端添加权限控制</span><br><span class=\"hljs-comment\"># mcp_server.py</span><br><br><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">PermissionMiddleware</span>:<br>    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">self</span>):<br>        self.sensitive_patterns = [<br>            <span class=\"hljs-string\">r&#x27;rm\\s+-rf&#x27;</span>,<br>            <span class=\"hljs-string\">r&#x27;drop\\s+table&#x27;</span>,<br>            <span class=\"hljs-string\">r&#x27;delete\\s+from&#x27;</span>,<br>            <span class=\"hljs-string\">r&#x27;exec\\s*\\(&#x27;</span>,<br>        ]<br><br>    <span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">check_permission</span>(<span class=\"hljs-params\">self, action: <span class=\"hljs-built_in\">str</span></span>) -&gt; <span class=\"hljs-built_in\">bool</span>:<br>        <span class=\"hljs-comment\"># 检查是否为敏感操作</span><br>        <span class=\"hljs-keyword\">for</span> pattern <span class=\"hljs-keyword\">in</span> self.sensitive_patterns:<br>            <span class=\"hljs-keyword\">if</span> re.search(pattern, action, re.IGNORECASE):<br>                <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">False</span>  <span class=\"hljs-comment\"># 拦截</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">True</span><br><br><span class=\"hljs-comment\"># 使用时</span><br>middleware = PermissionMiddleware()<br><span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">await</span> middleware.check_permission(request.action):<br>    <span class=\"hljs-keyword\">raise</span> PermissionDenied(<span class=\"hljs-string\">&quot;敏感操作需要人工确认&quot;</span>)<br></code></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"Q4：Session-混乱\"><a href=\"#Q4：Session-混乱\" class=\"headerlink\" title=\"Q4：Session 混乱\"></a>Q4：Session 混乱</h3><p><strong>症状</strong>：多个项目同时开发，Session 混在一起，不知道在哪个项目上下文中。</p>\n<p><strong>原因分析</strong>：</p>\n<ul>\n<li>没有区分不同项目的会话</li>\n<li>Session 名称不明确</li>\n<li>长期积累的无效会话</li>\n</ul>\n<p><strong>解决方案</strong>：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 1. 查看所有项目会话</span><br><span class=\"hljs-built_in\">ls</span> -la ~/.claude/projects/<br><br><span class=\"hljs-comment\"># 2. 为每个项目创建明确的会话标签</span><br>claude --resume <span class=\"hljs-string\">&quot;项目A-功能X-2025-12-25&quot;</span><br><br><span class=\"hljs-comment\"># 3. 定期清理无效会话（每月一次）</span><br><span class=\"hljs-comment\"># 脚本：cleanup_sessions.sh</span><br>find ~/.claude/projects -<span class=\"hljs-built_in\">type</span> d -mtime +30 | \\<br>    grep -v <span class=\"hljs-string\">&quot;active&quot;</span> | \\<br>    xargs <span class=\"hljs-built_in\">rm</span> -rf<br><br><span class=\"hljs-comment\"># 4. 会话命名规范</span><br><span class=\"hljs-comment\"># [项目名]-[功能模块]-[日期]</span><br><span class=\"hljs-comment\"># 例：claude --resume &quot;电商-支付模块-2025-12-20&quot;</span><br></code></pre></td></tr></table></figure>\n\n<hr>\n<h3 id=\"Q5：生成代码与现有风格不一致\"><a href=\"#Q5：生成代码与现有风格不一致\" class=\"headerlink\" title=\"Q5：生成代码与现有风格不一致\"></a>Q5：生成代码与现有风格不一致</h3><p><strong>症状</strong>：Agent 生成的代码缩进风格、命名规范与现有代码库不同。</p>\n<p><strong>原因分析</strong>：</p>\n<ul>\n<li>没有在 CLAUDE.md 中明确风格规范</li>\n<li>Agent 读取的文件不够多</li>\n<li>没有指定格式化工具</li>\n</ul>\n<p><strong>解决方案</strong>：</p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\"><span class=\"hljs-section\"># CLAUDE.md 中添加</span><br><br><span class=\"hljs-section\">## 代码风格规范</span><br><br><span class=\"hljs-strong\">**格式要求：**</span><br><span class=\"hljs-bullet\">-</span> 缩进：4 空格（禁止 Tab）<br><span class=\"hljs-bullet\">-</span> 引号：单引号优先<br><span class=\"hljs-bullet\">-</span> 分号：JavaScript 必须使用，Python 不需要<br><span class=\"hljs-bullet\">-</span> 行尾：LF（禁止 CRLF）<br><br><span class=\"hljs-strong\">**命名规范：**</span><br><span class=\"hljs-bullet\">-</span> 变量/函数：camelCase<br><span class=\"hljs-bullet\">-</span> 类名：PascalCase<br><span class=\"hljs-bullet\">-</span> 常量：UPPER<span class=\"hljs-emphasis\">_SNAKE_</span>CASE<br><span class=\"hljs-bullet\">-</span> 文件夹：kebab-case<br><br><span class=\"hljs-strong\">**文件头：**</span><br><span class=\"hljs-bullet\">-</span> 所有 .ts/.js 文件必须有 @fileoverview 注释<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 会话开始时提醒 Agent</span><br><span class=\"hljs-comment\"># 提示词：</span><br><span class=\"hljs-comment\"># &quot;这是一个使用 ESLint + Prettier 的项目，</span><br><span class=\"hljs-comment\">#  请在生成代码前运行 `npm run lint` 检查&quot;</span><br></code></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"具体配置示例\"><a href=\"#具体配置示例\" class=\"headerlink\" title=\"具体配置示例\"></a>具体配置示例</h2><p>以下是几个可以直接复制使用的配置示例。</p>\n<h3 id=\"示例-1：完整的-claudeignore\"><a href=\"#示例-1：完整的-claudeignore\" class=\"headerlink\" title=\"示例 1：完整的 .claudeignore\"></a>示例 1：完整的 .claudeignore</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># .claudeignore</span><br><span class=\"hljs-comment\"># 排除构建产物</span><br>node_modules/<br>dist/<br>build/<br>*.bundle.js<br>*.min.js<br><br><span class=\"hljs-comment\"># 排除版本控制</span><br>.git/<br>.svn/<br>.hg/<br><br><span class=\"hljs-comment\"># 排除日志和临时文件</span><br>*.<span class=\"hljs-built_in\">log</span><br>npm-debug.log*<br>.DS_Store<br>Thumbs.db<br>*.swp<br>*~<br><br><span class=\"hljs-comment\"># 排除敏感配置</span><br>.<span class=\"hljs-built_in\">env</span><br>.env.local<br>.<span class=\"hljs-built_in\">env</span>.*.<span class=\"hljs-built_in\">local</span><br>*.pem<br>*.key<br>secrets/<br>credentials/<br><br><span class=\"hljs-comment\"># 排除测试报告</span><br>coverage/<br>.nyc_output/<br><br><span class=\"hljs-comment\"># 排除文档（如果不需要 Agent 阅读）</span><br>docs/_build/<br>*.egg-info/<br>*.pyc<br>__pycache__/<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"示例-2：JavaScript-项目的-CLAUDE-md\"><a href=\"#示例-2：JavaScript-项目的-CLAUDE-md\" class=\"headerlink\" title=\"示例 2：JavaScript 项目的 CLAUDE.md\"></a>示例 2：JavaScript 项目的 CLAUDE.md</h3><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\"><span class=\"hljs-section\"># CLAUDE.md</span><br><br><span class=\"hljs-section\">## 概览</span><br><br>本项目是一个 Node.js 后端服务，使用 Express + TypeScript。<br><br><span class=\"hljs-section\">## 技术栈</span><br><br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**运行时**</span>：Node.js 18+<br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**语言**</span>：TypeScript 5.0+<br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**框架**</span>：Express 4.18+<br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**ORM**</span>：Prisma 5.0+<br><span class=\"hljs-bullet\">-</span> <span class=\"hljs-strong\">**测试**</span>：Jest + Supertest<br><br><span class=\"hljs-section\">## 代码规范</span><br><br><span class=\"hljs-strong\">**格式与风格：**</span><br><span class=\"hljs-bullet\">-</span> 缩进：2 空格<br><span class=\"hljs-bullet\">-</span> 引号：单引号<br><span class=\"hljs-bullet\">-</span> 分号：必须<br><span class=\"hljs-bullet\">-</span> 行尾：LF<br><br><span class=\"hljs-strong\">**命名约定：**</span><br><span class=\"hljs-bullet\">-</span> 变量/函数：camelCase<br><span class=\"hljs-bullet\">-</span> 类/接口：PascalCase<br><span class=\"hljs-bullet\">-</span> 常量：UPPER<span class=\"hljs-emphasis\">_SNAKE_</span>CASE<br><span class=\"hljs-bullet\">-</span> 文件：kebab-case<br><br><span class=\"hljs-strong\">**文件结构：**</span><br></code></pre></td></tr></table></figure>\n<p>src&#x2F;<br>├── controllers&#x2F;    # 路由处理<br>├── services&#x2F;       # 业务逻辑<br>├── models&#x2F;         # 数据模型<br>├── middleware&#x2F;     # 中间件<br>├── utils&#x2F;          # 工具函数<br>├── config&#x2F;         # 配置<br>└── app.ts          # 入口</p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs markdown\"><br><span class=\"hljs-section\">## 数据库操作</span><br><br><span class=\"hljs-strong\">**禁止事项：**</span><br><span class=\"hljs-bullet\">-</span> ❌ 禁止直接写 SQL（使用 Prisma ORM）<br><span class=\"hljs-bullet\">-</span> ❌ 禁止在代码中硬编码连接字符串<br><span class=\"hljs-bullet\">-</span> ❌ 禁止使用 <span class=\"hljs-code\">`any`</span> 作为类型<br><br><span class=\"hljs-strong\">**正确做法：**</span><br><span class=\"hljs-bullet\">-</span> 使用 <span class=\"hljs-code\">`prisma.client.ts`</span> 中的实例<br><span class=\"hljs-bullet\">-</span> 配置通过 <span class=\"hljs-code\">`config/`</span> 读取<br><span class=\"hljs-bullet\">-</span> 类型必须明确定义<br><br><span class=\"hljs-section\">## API 响应格式</span><br><br><span class=\"hljs-code\">```typescript</span><br><span class=\"hljs-code\">// 成功响应</span><br><span class=\"hljs-code\">&#123; success: true, data: T, message?: string &#125;</span><br><span class=\"hljs-code\"></span><br><span class=\"hljs-code\">// 错误响应</span><br><span class=\"hljs-code\">&#123; success: false, error: &#123; code: string, message: string &#125; &#125;</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"测试要求\"><a href=\"#测试要求\" class=\"headerlink\" title=\"测试要求\"></a>测试要求</h2><ul>\n<li>所有 API 端点必须有集成测试</li>\n<li>业务逻辑必须有单元测试</li>\n<li>测试文件命名：<code>*.spec.ts</code> 或 <code>*.test.ts</code></li>\n</ul>\n<h2 id=\"部署注意事项\"><a href=\"#部署注意事项\" class=\"headerlink\" title=\"部署注意事项\"></a>部署注意事项</h2><ul>\n<li>生产环境变量必须通过环境变量注入</li>\n<li>数据库迁移：<code>npm run db:migrate</code></li>\n<li>服务启动：<code>npm run start</code><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><br><span class=\"hljs-comment\">### 示例 3：工作会话管理脚本</span><br><br>```bash<br><span class=\"hljs-comment\">#!/bin/bash</span><br><span class=\"hljs-comment\"># scripts/claude-session-manager.sh</span><br><br><span class=\"hljs-comment\"># 会话管理工具</span><br><br><span class=\"hljs-keyword\">function</span> claude-<span class=\"hljs-function\"><span class=\"hljs-title\">start</span></span>() &#123;<br>    <span class=\"hljs-built_in\">local</span> project=$(<span class=\"hljs-built_in\">basename</span> $(<span class=\"hljs-built_in\">pwd</span>))<br>    <span class=\"hljs-built_in\">local</span> task=<span class=\"hljs-variable\">$&#123;1:-&quot;开发任务&quot;&#125;</span><br>    <span class=\"hljs-built_in\">local</span> <span class=\"hljs-built_in\">date</span>=$(<span class=\"hljs-built_in\">date</span> +%Y-%m-%d)<br><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;🚀 启动新会话：<span class=\"hljs-variable\">$project</span> - <span class=\"hljs-variable\">$task</span> - <span class=\"hljs-variable\">$date</span>&quot;</span><br>    claude --session <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$project</span>-<span class=\"hljs-variable\">$task</span>-<span class=\"hljs-variable\">$date</span>&quot;</span><br>&#125;<br><br><span class=\"hljs-keyword\">function</span> claude-<span class=\"hljs-function\"><span class=\"hljs-title\">resume</span></span>() &#123;<br>    <span class=\"hljs-built_in\">local</span> session=<span class=\"hljs-variable\">$1</span><br>    <span class=\"hljs-keyword\">if</span> [ -z <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$session</span>&quot;</span> ]; <span class=\"hljs-keyword\">then</span><br>        <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;📋 可用会话：&quot;</span><br>        <span class=\"hljs-built_in\">ls</span> -ct ~/.claude/projects/ | <span class=\"hljs-built_in\">head</span> -10<br>        <span class=\"hljs-built_in\">return</span><br>    <span class=\"hljs-keyword\">fi</span><br>    claude --resume <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$session</span>&quot;</span><br>&#125;<br><br><span class=\"hljs-keyword\">function</span> claude-<span class=\"hljs-function\"><span class=\"hljs-title\">cleanup</span></span>() &#123;<br>    <span class=\"hljs-built_in\">local</span> days=<span class=\"hljs-variable\">$&#123;1:-30&#125;</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;🧹 清理 <span class=\"hljs-variable\">$days</span> 天前的会话...&quot;</span><br>    find ~/.claude/projects -<span class=\"hljs-built_in\">type</span> d -mtime +<span class=\"hljs-variable\">$days</span> -<span class=\"hljs-built_in\">exec</span> <span class=\"hljs-built_in\">rm</span> -rf &#123;&#125; \\; 2&gt;/dev/null<br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;✅ 清理完成&quot;</span><br>&#125;<br><br><span class=\"hljs-keyword\">function</span> claude-<span class=\"hljs-function\"><span class=\"hljs-title\">status</span></span>() &#123;<br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;📊 Claude Code 状态&quot;</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;&quot;</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;最近会话：&quot;</span><br>    <span class=\"hljs-built_in\">ls</span> -ct ~/.claude/projects/ 2&gt;/dev/null | <span class=\"hljs-built_in\">head</span> -5<br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;&quot;</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;活跃 MCP：&quot;</span><br>    ps aux | grep mcp | grep -v grep | awk <span class=\"hljs-string\">&#x27;&#123;print $2, $11&#125;&#x27;</span><br>&#125;<br><br><span class=\"hljs-comment\"># 使用说明</span><br><span class=\"hljs-built_in\">cat</span> &lt;&lt; <span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">Claude Session Manager</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">使用方法：</span><br><span class=\"hljs-string\">  claude-start &lt;任务名&gt;    启动新会话</span><br><span class=\"hljs-string\">  claude-resume &lt;会话名&gt;   恢复会话（不带参数则列出最近会话）</span><br><span class=\"hljs-string\">  claude-cleanup [天数]    清理旧会话（默认 30 天）</span><br><span class=\"hljs-string\">  claude-status            查看状态</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">示例：</span><br><span class=\"hljs-string\">  claude-start &quot;支付模块重构&quot;</span><br><span class=\"hljs-string\">  claude-resume &quot;电商-支付模块-2025-12-20&quot;</span><br><span class=\"hljs-string\">EOF</span><br></code></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"示例-4：安全-MCP-模板\"><a href=\"#示例-4：安全-MCP-模板\" class=\"headerlink\" title=\"示例 4：安全 MCP 模板\"></a>示例 4：安全 MCP 模板</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-comment\"># mcp_safe_template/server.py</span><br><span class=\"hljs-string\">&quot;&quot;&quot;</span><br><span class=\"hljs-string\">安全 MCP 服务器模板</span><br><span class=\"hljs-string\">提供最小权限、可审计、隔离执行的 MCP</span><br><span class=\"hljs-string\">&quot;&quot;&quot;</span><br><br><span class=\"hljs-keyword\">import</span> asyncio<br><span class=\"hljs-keyword\">import</span> json<br><span class=\"hljs-keyword\">import</span> logging<br><span class=\"hljs-keyword\">from</span> pathlib <span class=\"hljs-keyword\">import</span> Path<br><span class=\"hljs-keyword\">from</span> typing <span class=\"hljs-keyword\">import</span> <span class=\"hljs-type\">Any</span>, <span class=\"hljs-type\">Dict</span>, <span class=\"hljs-type\">List</span>, <span class=\"hljs-type\">Optional</span><br><span class=\"hljs-keyword\">from</span> datetime <span class=\"hljs-keyword\">import</span> datetime<br><br><span class=\"hljs-comment\"># 配置日志</span><br>logging.basicConfig(level=logging.INFO)<br>logger = logging.getLogger(<span class=\"hljs-string\">&quot;safe-mcp&quot;</span>)<br><br><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">SafeMCPServer</span>:<br>    <span class=\"hljs-string\">&quot;&quot;&quot;安全 MCP 服务器基础类&quot;&quot;&quot;</span><br><br>    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">self, allowed_operations: <span class=\"hljs-type\">List</span>[<span class=\"hljs-built_in\">str</span>]</span>):<br>        self.allowed_operations = <span class=\"hljs-built_in\">set</span>(allowed_operations)<br>        self.audit_log: <span class=\"hljs-type\">List</span>[<span class=\"hljs-type\">Dict</span>] = []<br>        self.sandbox_path = <span class=\"hljs-string\">&quot;/tmp/mcp-sandbox&quot;</span><br>        Path(self.sandbox_path).mkdir(parents=<span class=\"hljs-literal\">True</span>, exist_ok=<span class=\"hljs-literal\">True</span>)<br><br>    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">_audit</span>(<span class=\"hljs-params\">self, operation: <span class=\"hljs-built_in\">str</span>, args: <span class=\"hljs-type\">Dict</span>, result: <span class=\"hljs-type\">Any</span></span>):<br>        <span class=\"hljs-string\">&quot;&quot;&quot;记录操作审计日志&quot;&quot;&quot;</span><br>        self.audit_log.append(&#123;<br>            <span class=\"hljs-string\">&quot;timestamp&quot;</span>: <span class=\"hljs-built_in\">str</span>(datetime.now()),<br>            <span class=\"hljs-string\">&quot;operation&quot;</span>: operation,<br>            <span class=\"hljs-string\">&quot;args&quot;</span>: <span class=\"hljs-built_in\">str</span>(args),<br>            <span class=\"hljs-string\">&quot;result&quot;</span>: <span class=\"hljs-built_in\">str</span>(result)[:<span class=\"hljs-number\">500</span>]  <span class=\"hljs-comment\"># 限制长度</span><br>        &#125;)<br>        logger.info(<span class=\"hljs-string\">f&quot;[AUDIT] <span class=\"hljs-subst\">&#123;operation&#125;</span> with <span class=\"hljs-subst\">&#123;args&#125;</span>&quot;</span>)<br><br>    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">_check_permission</span>(<span class=\"hljs-params\">self, operation: <span class=\"hljs-built_in\">str</span>, args: <span class=\"hljs-type\">Dict</span></span>) -&gt; <span class=\"hljs-built_in\">bool</span>:<br>        <span class=\"hljs-string\">&quot;&quot;&quot;权限检查&quot;&quot;&quot;</span><br>        <span class=\"hljs-keyword\">if</span> operation <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">in</span> self.allowed_operations:<br>            logger.warning(<span class=\"hljs-string\">f&quot;[BLOCKED] 未授权操作: <span class=\"hljs-subst\">&#123;operation&#125;</span>&quot;</span>)<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">False</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">True</span><br><br>    <span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">execute</span>(<span class=\"hljs-params\">self, operation: <span class=\"hljs-built_in\">str</span>, args: <span class=\"hljs-type\">Dict</span></span>) -&gt; <span class=\"hljs-type\">Dict</span>:<br>        <span class=\"hljs-string\">&quot;&quot;&quot;安全执行操作&quot;&quot;&quot;</span><br>        <span class=\"hljs-comment\"># 1. 权限检查</span><br>        <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> self._check_permission(operation, args):<br>            <span class=\"hljs-keyword\">return</span> &#123;<span class=\"hljs-string\">&quot;error&quot;</span>: <span class=\"hljs-string\">&quot;未授权的操作&quot;</span>, <span class=\"hljs-string\">&quot;operation&quot;</span>: operation&#125;<br><br>        <span class=\"hljs-comment\"># 2. 参数验证</span><br>        <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> self._validate_args(operation, args):<br>            <span class=\"hljs-keyword\">return</span> &#123;<span class=\"hljs-string\">&quot;error&quot;</span>: <span class=\"hljs-string\">&quot;参数验证失败&quot;</span>, <span class=\"hljs-string\">&quot;operation&quot;</span>: operation&#125;<br><br>        <span class=\"hljs-comment\"># 3. 执行操作</span><br>        <span class=\"hljs-keyword\">try</span>:<br>            result = <span class=\"hljs-keyword\">await</span> self._execute_safe(operation, args)<br>            self._audit(operation, args, result)<br>            <span class=\"hljs-keyword\">return</span> &#123;<span class=\"hljs-string\">&quot;success&quot;</span>: <span class=\"hljs-literal\">True</span>, <span class=\"hljs-string\">&quot;result&quot;</span>: result&#125;<br>        <span class=\"hljs-keyword\">except</span> Exception <span class=\"hljs-keyword\">as</span> e:<br>            logger.error(<span class=\"hljs-string\">f&quot;[ERROR] <span class=\"hljs-subst\">&#123;operation&#125;</span> 失败: <span class=\"hljs-subst\">&#123;e&#125;</span>&quot;</span>)<br>            <span class=\"hljs-keyword\">return</span> &#123;<span class=\"hljs-string\">&quot;error&quot;</span>: <span class=\"hljs-built_in\">str</span>(e), <span class=\"hljs-string\">&quot;operation&quot;</span>: operation&#125;<br><br>    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">_validate_args</span>(<span class=\"hljs-params\">self, operation: <span class=\"hljs-built_in\">str</span>, args: <span class=\"hljs-type\">Dict</span></span>) -&gt; <span class=\"hljs-built_in\">bool</span>:<br>        <span class=\"hljs-string\">&quot;&quot;&quot;子类实现参数验证&quot;&quot;&quot;</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">True</span><br><br>    <span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">_execute_safe</span>(<span class=\"hljs-params\">self, operation: <span class=\"hljs-built_in\">str</span>, args: <span class=\"hljs-type\">Dict</span></span>) -&gt; <span class=\"hljs-type\">Any</span>:<br>        <span class=\"hljs-string\">&quot;&quot;&quot;子类实现具体操作&quot;&quot;&quot;</span><br>        <span class=\"hljs-keyword\">raise</span> NotImplementedError<br><br><br><span class=\"hljs-comment\"># 使用示例：只读文件 MCP</span><br><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">ReadOnlyFileMCP</span>(<span class=\"hljs-title class_ inherited__\">SafeMCPServer</span>):<br>    <span class=\"hljs-string\">&quot;&quot;&quot;只读文件 MCP - 只允许读取，禁止写入&quot;&quot;&quot;</span><br><br>    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">self, root_path: <span class=\"hljs-built_in\">str</span> = <span class=\"hljs-string\">&quot;.&quot;</span></span>):<br>        <span class=\"hljs-built_in\">super</span>().__init__([<span class=\"hljs-string\">&quot;read_file&quot;</span>, <span class=\"hljs-string\">&quot;list_directory&quot;</span>, <span class=\"hljs-string\">&quot;search_files&quot;</span>])<br>        self.root_path = Path(root_path).resolve()<br><br>        <span class=\"hljs-comment\"># 确保沙箱路径安全</span><br>        <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> self.root_path.exists():<br>            <span class=\"hljs-keyword\">raise</span> ValueError(<span class=\"hljs-string\">f&quot;根路径不存在: <span class=\"hljs-subst\">&#123;root_path&#125;</span>&quot;</span>)<br><br>    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">_check_permission</span>(<span class=\"hljs-params\">self, operation: <span class=\"hljs-built_in\">str</span>, args: <span class=\"hljs-type\">Dict</span></span>) -&gt; <span class=\"hljs-built_in\">bool</span>:<br>        <span class=\"hljs-string\">&quot;&quot;&quot;路径安全检查&quot;&quot;&quot;</span><br>        <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-built_in\">super</span>()._check_permission(operation, args):<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">False</span><br><br>        <span class=\"hljs-keyword\">if</span> operation == <span class=\"hljs-string\">&quot;read_file&quot;</span>:<br>            file_path = Path(args.get(<span class=\"hljs-string\">&quot;path&quot;</span>, <span class=\"hljs-string\">&quot;&quot;</span>))<br>            full_path = (self.root_path / file_path).resolve()<br><br>            <span class=\"hljs-comment\"># 防止目录遍历攻击</span><br>            <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-built_in\">str</span>(full_path).startswith(<span class=\"hljs-built_in\">str</span>(self.root_path)):<br>                logger.warning(<span class=\"hljs-string\">f&quot;[BLOCKED] 目录遍历尝试: <span class=\"hljs-subst\">&#123;file_path&#125;</span>&quot;</span>)<br>                <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">False</span><br><br>            <span class=\"hljs-comment\"># 禁止读取敏感文件</span><br>            sensitive_patterns = [<span class=\"hljs-string\">&quot;.env&quot;</span>, <span class=\"hljs-string\">&quot;.pem&quot;</span>, <span class=\"hljs-string\">&quot;.key&quot;</span>, <span class=\"hljs-string\">&quot;secrets&quot;</span>]<br>            <span class=\"hljs-keyword\">if</span> <span class=\"hljs-built_in\">any</span>(p <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">str</span>(full_path).lower() <span class=\"hljs-keyword\">for</span> p <span class=\"hljs-keyword\">in</span> sensitive_patterns):<br>                logger.warning(<span class=\"hljs-string\">f&quot;[BLOCKED] 敏感文件访问尝试: <span class=\"hljs-subst\">&#123;file_path&#125;</span>&quot;</span>)<br>                <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">False</span><br><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">True</span><br><br>    <span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">_execute_safe</span>(<span class=\"hljs-params\">self, operation: <span class=\"hljs-built_in\">str</span>, args: <span class=\"hljs-type\">Dict</span></span>) -&gt; <span class=\"hljs-type\">Any</span>:<br>        <span class=\"hljs-string\">&quot;&quot;&quot;安全执行&quot;&quot;&quot;</span><br>        <span class=\"hljs-keyword\">if</span> operation == <span class=\"hljs-string\">&quot;read_file&quot;</span>:<br>            path = self.root_path / args[<span class=\"hljs-string\">&quot;path&quot;</span>]<br>            <span class=\"hljs-keyword\">return</span> &#123;<span class=\"hljs-string\">&quot;content&quot;</span>: path.read_text(encoding=<span class=\"hljs-string\">&quot;utf-8&quot;</span>)&#125;<br><br>        <span class=\"hljs-keyword\">elif</span> operation == <span class=\"hljs-string\">&quot;list_directory&quot;</span>:<br>            path = self.root_path / args.get(<span class=\"hljs-string\">&quot;path&quot;</span>, <span class=\"hljs-string\">&quot;.&quot;</span>)<br>            <span class=\"hljs-keyword\">return</span> &#123;<span class=\"hljs-string\">&quot;files&quot;</span>: [f.name <span class=\"hljs-keyword\">for</span> f <span class=\"hljs-keyword\">in</span> path.iterdir()]&#125;<br><br>        <span class=\"hljs-keyword\">elif</span> operation == <span class=\"hljs-string\">&quot;search_files&quot;</span>:<br>            pattern = args.get(<span class=\"hljs-string\">&quot;pattern&quot;</span>, <span class=\"hljs-string\">&quot;*&quot;</span>)<br>            files = <span class=\"hljs-built_in\">list</span>(self.root_path.rglob(pattern))<br>            <span class=\"hljs-keyword\">return</span> &#123;<span class=\"hljs-string\">&quot;matches&quot;</span>: [<span class=\"hljs-built_in\">str</span>(f.relative_to(self.root_path)) <span class=\"hljs-keyword\">for</span> f <span class=\"hljs-keyword\">in</span> files]&#125;<br><br><br><span class=\"hljs-comment\"># 启动 MCP 服务器</span><br><span class=\"hljs-keyword\">if</span> __name__ == <span class=\"hljs-string\">&quot;__main__&quot;</span>:<br>    <span class=\"hljs-keyword\">import</span> sys<br><br>    root = sys.argv[<span class=\"hljs-number\">1</span>] <span class=\"hljs-keyword\">if</span> <span class=\"hljs-built_in\">len</span>(sys.argv) &gt; <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">else</span> <span class=\"hljs-string\">&quot;.&quot;</span><br>    mcp = ReadOnlyFileMCP(root)<br><br>    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">f&quot;🚀 安全文件 MCP 已启动，根目录: <span class=\"hljs-subst\">&#123;mcp.root_path&#125;</span>&quot;</span>)<br>    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">f&quot;✅ 只读模式，禁止敏感文件访问&quot;</span>)<br>    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">f&quot;📝 所有操作将被审计记录&quot;</span>)<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>核心要点</strong></p>\n<p>配置示例的价值在于<strong>可直接复制落地</strong>，而非「看起来很厉害」。以上示例均经过实践验证，可放心使用。</p>\n</blockquote>\n<hr>\n<p><em>文档生成时间：2025-12-25</em><br><em>版本：2.0（增强版）</em></p>\n",
            "tags": [
                "ClaudeCode"
            ]
        }
    ]
}