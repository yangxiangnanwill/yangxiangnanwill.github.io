<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="will"><meta name="keywords" content="will"><meta name="description" content="高并发带来的问题在微服务架构中，我们将业务拆分成一个个的服务，服务与服务之间可以相互调用，但是由于网络原因或者自身的原因，服务并不能保证服务的100%可用，如果单个服务出现问题，调用这个服务就会出现网络延迟，此时若有大量的网络涌入，会形成任务堆积，最终导致服务瘫痪。 接下来我们通过一个案例，来模拟一下一个高并发的场景。  新建HighConcurrencyController测试类  123456"><meta property="og:type" content="article"><meta property="og:title" content="Spring-Cloud-Alibaba(4)-服务容错"><meta property="og:url" content="https://github.com/yangxiangnanwill/yangxiangnanwill.github.io/2023/05/28/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/JAVA/Spring/Spring-Cloud-Alibaba(4)-%E6%9C%8D%E5%8A%A1%E5%AE%B9%E9%94%99/index.html"><meta property="og:site_name" content="Will"><meta property="og:description" content="高并发带来的问题在微服务架构中，我们将业务拆分成一个个的服务，服务与服务之间可以相互调用，但是由于网络原因或者自身的原因，服务并不能保证服务的100%可用，如果单个服务出现问题，调用这个服务就会出现网络延迟，此时若有大量的网络涌入，会形成任务堆积，最终导致服务瘫痪。 接下来我们通过一个案例，来模拟一下一个高并发的场景。  新建HighConcurrencyController测试类  123456"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://ftp.bmp.ovh/imgs/2021/07/806b4e49574f0d7c.jpg"><meta property="og:image" content="https://z3.ax1x.com/2021/07/18/W8Nehj.png"><meta property="og:image" content="https://ftp.bmp.ovh/imgs/2021/07/d869eb55dcf31cd1.png"><meta property="og:image" content="https://ftp.bmp.ovh/imgs/2021/07/70b99c97f9b0c76b.png"><meta property="og:image" content="https://user-images.githubusercontent.com/9434884/53381986-a0b73f00-39ad-11e9-90cf-b49158ae4b6f.png"><meta property="og:image" content="https://z3.ax1x.com/2021/07/18/W8YnaQ.png"><meta property="og:image" content="https://z3.ax1x.com/2021/07/18/W8Yl2q.png"><meta property="og:image" content="https://z3.ax1x.com/2021/07/18/W8YNa4.png"><meta property="og:image" content="https://z3.ax1x.com/2021/07/18/W8YBxx.png"><meta property="og:image" content="https://z3.ax1x.com/2021/07/18/W8YssK.png"><meta property="og:image" content="https://z3.ax1x.com/2021/07/18/W8YNa4.png"><meta property="og:image" content="https://z3.ax1x.com/2021/07/18/W8YhRI.png"><meta property="og:image" content="https://z3.ax1x.com/2021/07/18/W8YTL8.png"><meta property="og:image" content="https://z3.ax1x.com/2021/07/18/W8YzQ0.png"><meta property="og:image" content="https://z3.ax1x.com/2021/07/18/W8tio4.png"><meta property="og:image" content="https://i.bmp.ovh/imgs/2021/09/34f69b017981f9a6.png"><meta property="og:image" content="https://i.bmp.ovh/imgs/2021/09/14bfdc57aeca8152.png"><meta property="og:image" content="https://i.loli.net/2021/09/05/ySYaLxKuJf9sDOU.png"><meta property="og:image" content="https://i.bmp.ovh/imgs/2021/09/0d1b9c0cae07396d.png"><meta property="og:image" content="https://i.bmp.ovh/imgs/2021/09/94bc40c52a38bde8.png"><meta property="og:image" content="https://i.bmp.ovh/imgs/2021/09/ad32eb08f12b3954.png"><meta property="og:image" content="https://i.loli.net/2021/09/05/gbKIefCR5xQZNTW.png"><meta property="og:image" content="https://i.bmp.ovh/imgs/2021/09/cd5c368316e6c777.png"><meta property="article:published_time" content="2023-05-28T13:00:29.400Z"><meta property="article:modified_time" content="2023-05-28T13:03:53.383Z"><meta property="article:author" content="will"><meta property="article:tag" content="JAVA"><meta property="article:tag" content="Spring"><meta property="article:tag" content="SpringCloud"><meta property="article:tag" content="SpringCloud Alibaba"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://ftp.bmp.ovh/imgs/2021/07/806b4e49574f0d7c.jpg"><title>Spring-Cloud-Alibaba(4)-服务容错 - Will</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var dntVal,Fluid=window.Fluid||{},CONFIG=(Fluid.ctx=Object.assign({},Fluid.ctx),{hostname:"github.com",root:"/",version:"1.9.4",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"});CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>WILL</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Spring-Cloud-Alibaba(4)-服务容错"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-05-28 21:00" pubdate>2023年5月28日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 25k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 212 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">Spring-Cloud-Alibaba(4)-服务容错</h1><div class="markdown-body"><h1 id="高并发带来的问题"><a href="#高并发带来的问题" class="headerlink" title="高并发带来的问题"></a>高并发带来的问题</h1><p>在微服务架构中，我们将业务拆分成一个个的服务，服务与服务之间可以相互调用，但是由于网络原因或者自身的原因，服务并不能保证服务的100%可用，如果单个服务出现问题，调用这个服务就会出现网络延迟，此时若有大量的网络涌入，会形成任务堆积，最终导致服务瘫痪。</p><p>接下来我们通过一个案例，来模拟一下一个高并发的场景。</p><ul><li>新建<code>HighConcurrencyController</code>测试类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> HighConcurrencyController</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> will</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/7/12 20:50</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RequestMapping(&quot;/highConcurrency&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HighConcurrencyController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ProductFeignClient productFeignClient;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 保存指定产品订单</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/save/&#123;pId&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">order</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;pId&quot;)</span> Integer pId, <span class="hljs-meta">@RequestParam(name = &quot;queryType&quot;)</span> String queryType)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;&gt;&gt;客户下单，这时候要调用商品微服务查询商品信息&quot;</span>);<br>        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// 通过restTemplate调用商品微服务</span><br>        product = queryProductLoadBalancingByFeign(pId);<br>        log.info(<span class="hljs-string">&quot;&gt;&gt;商品信息,查询结果:&quot;</span> + JSON.toJSONString(product));<br>        <span class="hljs-comment">//模拟网络延时</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000L</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();<br>        order.setUId(<span class="hljs-number">1</span>);<br>        order.setUserName(<span class="hljs-string">&quot;测试用户&quot;</span>);<br>        order.setPId(product.getPId());<br>        order.setPName(product.getPName());<br>        order.setPPrice(product.getPPrice());<br>        order.setNumber(<span class="hljs-number">1</span>);<br>        orderService.saveOrder(order);<br>        <span class="hljs-keyword">return</span> order;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/getMessage&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMessage</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;测试高并发&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * RestTemplate   负载均衡风格查询</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pId    产品id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Product <span class="hljs-title function_">queryProductLoadBalancingByFeign</span><span class="hljs-params">(Integer pId)</span> &#123;<br>        <span class="hljs-type">ProductVO</span> <span class="hljs-variable">productVO</span> <span class="hljs-operator">=</span> productFeignClient.queryProductInfoByProductId(pId);<br>        <span class="hljs-keyword">if</span> (productVO != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();<br>            BeanUtils.copyProperties(productVO, product);<br>            <span class="hljs-keyword">return</span> product;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>修改配置文件中tomcat的并发数</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8091</span><br>  <span class="hljs-attr">tomcat:</span><br>    <span class="hljs-attr">max-threads:</span> <span class="hljs-number">10</span> <span class="hljs-comment">#tomcat的最大并发值修改为10,默认是200</span><br></code></pre></td></tr></table></figure><ul><li>压力测试</li></ul><blockquote><p>本次使用jmeter进行压力测试，创建步骤为：</p><ul><li>创建线程组，线程数量为20，间隔时间为1s，循环次数为：100次；</li><li>创建http请求，填写创建订单请求信息</li><li>创建查看结果树，查看请求结果</li><li>启动</li></ul></blockquote><ul><li>访问ｍessage方法观察效果</li></ul><p>结论：</p><blockquote><p>此时会发现, 由于order方法囤积了大量请求, 导致ｍessage方法的访问出现了问题，这就是服务雪崩的雏形。</p></blockquote><h1 id="服务雪崩效应"><a href="#服务雪崩效应" class="headerlink" title="服务雪崩效应"></a>服务雪崩效应</h1><p><strong>在分布式系统中,由于网络原因或自身的原因,服务一般无法保证 100% 可用。如果一个服务出现了问题，调用这个服务就会出现线程阻塞的情况，此时若有大量的请求涌入，就会出现多条线程阻塞等待，进而导致服务瘫痪。</strong>​<strong>由于服务与服务之间的依赖性，故障会传播，会对整个微服务系统造成灾难性的严重后果，这就是服务故障的 “雪崩效应”。</strong></p><p><img src="https://ftp.bmp.ovh/imgs/2021/07/806b4e49574f0d7c.jpg" srcset="/img/loading.gif" lazyload></p><p><strong>雪崩发生的原因多种多样，有不合理的容量设计，或者是高并发下某一个方法响应变慢，亦或是某台机器的资源耗尽。我们无法完全杜绝雪崩源头的发生，只有做好足够的容错，保证在一个服务发生问题，不会影响到其它服务的正常运行。也就是＂雪落而不雪崩＂。</strong></p><h1 id="常见容错方案"><a href="#常见容错方案" class="headerlink" title="常见容错方案"></a>常见容错方案</h1><p>要防止雪崩的扩散，我们就要做好服务的容错，容错说白了就是保护自己不被猪队友拖垮的一些措施, 下面介绍常见的服务容错思路和组件。</p><h2 id="常见的容错思路"><a href="#常见的容错思路" class="headerlink" title="常见的容错思路"></a>常见的容错思路</h2><p>常见的容错思路有隔离、超时、限流、熔断、降级这几种，下面分别介绍一下。</p><h3 id="隔离"><a href="#隔离" class="headerlink" title="隔离"></a>隔离</h3><p>它是指将系统按照一定的原则划分为若干个服务模块，各个模块之间相对独立，无强依赖。当有故障发生时，能将问题和影响隔离在某个模块内部，而不扩散风险，不波及其它模块，不影响整体的系统服务。常见的隔离方式有：线程池隔离和信号量隔离．</p><p><img src="https://z3.ax1x.com/2021/07/18/W8Nehj.png" srcset="/img/loading.gif" lazyload alt="W8Nehj.png"><a target="_blank" rel="noopener" href="https://imgtu.com/i/W8Nehj">https://imgtu.com/i/W8Nehj</a></p><h3 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h3><p>在上游服务调用下游服务的时候，设置一个最大响应时间，如果超过这个时间，下游未作出反应，就断开请求，释放掉线程。</p><h3 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h3><p>限流就是限制系统的输入和输出流量已达到保护系统的目的。为了保证系统的稳固运行,一旦达到的需要限制的阈值,就需要限制流量并采取少量措施以完成限制流量的目的。</p><h3 id="熔断"><a href="#熔断" class="headerlink" title="熔断"></a>熔断</h3><p>在互联网系统中，当下游服务因访问压力过大而响应变慢或失败，上游服务为了保护系统整体的可用性，可以暂时切断对下游服务的调用。这种牺牲局部，保全整体的措施就叫做熔断。</p><p>服务熔断一般有三种状态：</p><ul><li>熔断关闭状态（Closed）<br>服务没有故障时，熔断器所处的状态，对调用方的调用不做任何限制</li><li>熔断开启状态（Open）<br>后续对该服务接口的调用不再经过网络，直接执行本地的fallback方法</li><li>半熔断状态（Half-Open）<br>尝试恢复服务调用，允许有限的流量调用该服务，并监控调用成功率。如果成功率达到预期，则说明服务已恢复，进入熔断关闭状态；如果成功率仍旧很低，则重新进入熔断关闭状态。</li></ul><h3 id="降级"><a href="#降级" class="headerlink" title="降级"></a>降级</h3><p>降级其实就是为服务提供一个托底方案，一旦服务无法正常调用，就使用托底方案。</p><h1 id="常见的容错组件"><a href="#常见的容错组件" class="headerlink" title="常见的容错组件"></a>常见的容错组件</h1><h2 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h2><p>Hystrix是由Netflix开源的一个延迟和容错库，用于隔离访问远程系统、服务或者第三方库，防止级联失败，从而提升系统的可用性与容错性。</p><h2 id="Resilience4J"><a href="#Resilience4J" class="headerlink" title="Resilience4J"></a>Resilience4J</h2><p>Resilicence4J一款非常轻量、简单，并且文档非常清晰、丰富的熔断工具，这也是Hystrix官方推荐的替代产品。不仅如此，Resilicence4j还原生支持Spring Boot 1.x&#x2F;2.x，而且监控也支持和prometheus等多款主流产品进行整合。</p><h2 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h2><p>Sentinel 是阿里巴巴开源的一款断路器实现，本身在阿里内部已经被大规模采用，非常稳定。</p><h2 id="组件对比"><a href="#组件对比" class="headerlink" title="组件对比"></a>组件对比</h2><table><thead><tr><th></th><th>Sentinel</th><th>Hystrix</th><th>resilience4j</th></tr></thead><tbody><tr><td>隔离策略</td><td>信号量隔离（并发线程数限流）</td><td>线程池隔离&#x2F;信号隔离</td><td>信号量隔离</td></tr><tr><td>熔断降级策略</td><td>基于响应时间、异常比率、异常数</td><td>基于异常比率</td><td>基于异常比率、响应</td></tr><tr><td>实时统计实现</td><td>滑动窗口（LeapArray）</td><td>滑动窗口（基于RxJava)</td><td>Ring Bit Buffer</td></tr><tr><td>动态规则配置</td><td>支持多种数据源</td><td>支持多种数据</td><td>有限支持</td></tr><tr><td>扩展性</td><td>多个扩展点</td><td>插件的形式</td><td>接口的形式</td></tr><tr><td>基于注解的支持</td><td>:white_check_mark:</td><td>:white_check_mark:</td><td>:white_check_mark:</td></tr><tr><td>限流</td><td>基于 QPS，支持基于调用关系的限流</td><td>有限的支持</td><td>Rate Limiter</td></tr><tr><td>流量整形</td><td>支持预热模式、匀速器模式、预热排队模式</td><td>:x:</td><td>简单的RateLimiter</td></tr><tr><td>系统自适应保护</td><td>:white_check_mark:</td><td>:x:</td><td>:x:</td></tr><tr><td>控制台</td><td>提供开箱即用的控制台，可配置规则、查看秒级监控、机器发现等</td><td>简单的监控查看</td><td>不提供控制台，可对接其它监控系统</td></tr></tbody></table><h1 id="Sentinel入门"><a href="#Sentinel入门" class="headerlink" title="Sentinel入门"></a>Sentinel入门</h1><h2 id="什么是Sentinel"><a href="#什么是Sentinel" class="headerlink" title="什么是Sentinel"></a>什么是Sentinel</h2><p>Sentinel (分布式系统的流量防卫兵) 是阿里开源的一套用于服务容错的综合性解决方案。它以流量为切入点, 从流量控制、熔断降级、系统负载保护等多个维度来保护服务的稳定性。</p><p>Sentinel 具有以下特征:</p><ul><li>丰富的应用场景：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景, 例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</li><li>完备的实时监控：Sentinel 提供了实时的监控功能。通过控制台可以看到接入应用的单台机器秒级数据, 甚至 500 台以下规模的集群的汇总运行情况。<br>广泛的开源生态：Sentinel 提供开箱即用的与其它开源框架&#x2F;库的整合模块, 例如与 Spring Cloud、Dubbo、gRPC 的整合。只需要引入相应的依赖并进行简单的配置即可快速地接入Sentinel。</li><li>完善的 SPI 扩展点：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</li></ul><p>Sentinel 分为两个部分:</p><ul><li>核心库（Java 客户端）不依赖任何框架&#x2F;库,能够运行于所有 Java 运行时环境，同时对 Dubbo &#x2F;Spring Cloud 等框架也有较好的支持。</li><li>控制台（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器。</li></ul><h2 id="微服务集成Sentinel"><a href="#微服务集成Sentinel" class="headerlink" title="微服务集成Sentinel"></a>微服务集成Sentinel</h2><p>为微服务集成Sentinel非常简单, 只需要加入Sentinel的依赖即可</p><h3 id="下载jar包"><a href="#下载jar包" class="headerlink" title="下载jar包"></a>下载jar包</h3><p>访问<a href="https://github.com/alibaba/Sentinel/releases">sentinel的官方</a>​<a href="https://github.com/alibaba/Sentinel/releases"><code>GitHub</code></a>​<a href="https://github.com/alibaba/Sentinel/releases">仓库下载jar包</a></p><h3 id="启动jar包"><a href="#启动jar包" class="headerlink" title="启动jar包"></a>启动jar包</h3><blockquote><p>直接使用jar命令启动项目(控制台本身是一个SpringBoot项目)</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">java -jar sentinel-dashboard-1.8.2.jar -Dserver.port=8080 -Dcsp.sentinel.dashboard.server=localhost:8080 -Dporject.name=sentinel-dashboard<br></code></pre></td></tr></table></figure><h3 id="在测试高并发专用接口"><a href="#在测试高并发专用接口" class="headerlink" title="在测试高并发专用接口"></a>在测试高并发专用接口</h3><blockquote><p><code>HighConcurrencyController</code>中添加测试方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/message1&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">message1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message1&quot;</span>;<br>&#125;<br><br><span class="hljs-meta">@RequestMapping(&quot;/message2&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">message2</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message2&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--sentinel--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="添加配置"><a href="#添加配置" class="headerlink" title="添加配置"></a>添加配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">sentinel:</span><br>  <span class="hljs-attr">transport:</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">9999</span> <span class="hljs-comment">#跟控制台交流的端口,随意指定一个未使用的端口即可</span><br>    <span class="hljs-attr">dashboard:</span> <span class="hljs-string">localhost:8080</span><br></code></pre></td></tr></table></figure><h3 id="启动order服务测试"><a href="#启动order服务测试" class="headerlink" title="启动order服务测试"></a>启动order服务测试</h3><p>启动成功后访问地址：<code>localhost:8080</code>，账号和密码默认都是sentinel，访问后你会发现服务信息为空白。</p><p><img src="https://ftp.bmp.ovh/imgs/2021/07/d869eb55dcf31cd1.png" srcset="/img/loading.gif" lazyload></p><h3 id="发送-highConcurrency-message1请求，再次测试"><a href="#发送-highConcurrency-message1请求，再次测试" class="headerlink" title="发送/highConcurrency/message1请求，再次测试"></a>发送<code>/highConcurrency/message1</code>请求，再次测试</h3><p><img src="https://ftp.bmp.ovh/imgs/2021/07/70b99c97f9b0c76b.png" srcset="/img/loading.gif" lazyload></p><h3 id="补充：了解控制台的使用原理"><a href="#补充：了解控制台的使用原理" class="headerlink" title="补充：了解控制台的使用原理"></a>补充：了解控制台的使用原理</h3><p>Sentinel的控制台其实就是一个SpringBoot编写的程序。我们需要将我们的微服务程序注册到控制台上,即在微服务中指定控制台的地址, 并且还要开启一个跟控制台传递数据的端口, 控制台也可以通过此端口调用微服务中的监控程序获取微服务的各种信息。</p><p><img src="https://user-images.githubusercontent.com/9434884/53381986-a0b73f00-39ad-11e9-90cf-b49158ae4b6f.png" srcset="/img/loading.gif" lazyload></p><h3 id="入门案例-实现一个接口的限流"><a href="#入门案例-实现一个接口的限流" class="headerlink" title="入门案例[实现一个接口的限流]"></a>入门案例[实现一个接口的限流]</h3><ul><li>通过控制台为message1添加一个流控规则</li></ul><p><img src="https://z3.ax1x.com/2021/07/18/W8YnaQ.png" srcset="/img/loading.gif" lazyload alt="W8YnaQ.png"><a target="_blank" rel="noopener" href="https://imgtu.com/i/W8YnaQ">https://imgtu.com/i/W8YnaQ</a></p><p><img src="https://z3.ax1x.com/2021/07/18/W8Yl2q.png" srcset="/img/loading.gif" lazyload alt="W8Yl2q.png"><a target="_blank" rel="noopener" href="https://imgtu.com/i/W8Yl2q">https://imgtu.com/i/W8Yl2q</a></p><ul><li>通过控制台快速频繁访问, 观察效果</li></ul><p><img src="https://z3.ax1x.com/2021/07/18/W8YNa4.png" srcset="/img/loading.gif" lazyload alt="W8YNa4.png"><a target="_blank" rel="noopener" href="https://imgtu.com/i/W8YNa4">https://imgtu.com/i/W8YNa4</a></p><h1 id="Sentinel的概念和功能"><a href="#Sentinel的概念和功能" class="headerlink" title="Sentinel的概念和功能"></a>Sentinel的概念和功能</h1><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h3><p><strong>资源就是Sentinel要保护的东西</strong></p><p>资源是 Sentinel 的关键概念。它可以是 Java 应用程序中的任何内容，可以是一个服务，也可以是一个方法，甚至可以是一段代码。</p><blockquote><p>我们入门案例中的message1方法就可以认为是一个资源</p></blockquote><h3 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h3><p><strong>规则就是用来定义如何进行保护资源的</strong></p><p>作用在资源之上, 定义以什么样的方式保护资源，主要包括流量控制规则、熔断降级规则以及系统保护规则。</p><blockquote><p>我们入门案例中就是为message1资源设置了一种流控规则, 限制了进入message1的流量</p></blockquote><h2 id="重要功能"><a href="#重要功能" class="headerlink" title="重要功能"></a>重要功能</h2><p>Sentinel的主要功能就是容错，主要体现为下面这三个：</p><ul><li><p>流量控制<br>流量控制在网络传输中是一个常用的概念，它用于调整网络包的数据。任意时间到来的请求往往是随机不可控的，而系统的处理能力是有限的。我们需要根据系统的处理能力对流量进行控制。Sentinel 作为一个调配器，可以根据需要把随机的请求调整成合适的形状。</p></li><li><p>熔断降级<br>当检测到调用链路中某个资源出现不稳定的表现，例如请求响应时间长或异常比例升高的时候，则对这个资源的调用进行限制，让请求快速失败，避免影响到其它的资源而导致级联故障。Sentinel 对这个问题采取了两种手段:</p><ul><li>通过并发线程数进行限制<br>Sentinel 通过限制资源并发线程的数量，来减少不稳定资源对其它资源的影响。当某个资源出现不稳定的情况下，例如响应时间变长，对资源的直接影响就是会造成线程数的逐步堆积。当线程数在特定资源上堆积到一定的数量之后，对该资源的新请求就会被拒绝。堆积的线程完成任务后才开始继续接收请求。</li><li>通过响应时间对资源进行降级<br>除了对并发线程数进行控制以外，Sentinel 还可以通过响应时间来快速降级不稳定的资源。当依赖的资源出现响应时间过长后，所有对该资源的访问都会被直接拒绝，直到过了指定的时间窗口之后才重新恢复。</li></ul></li></ul><blockquote><p>Sentinel 和 Hystrix 的区别<br>两者的原则是一致的, 都是当一个资源出现问题时, 让其快速失败, 不要波及到其它服务但是在限制的手段上, 确采取了完全不一样的方法:</p><ul><li>Hystrix 采用的是线程池隔离的方式, 优点是做到了资源之间的隔离, 缺点是增加了线程切换的成本。</li><li>Sentinel 采用的是通过并发线程的数量和响应时间来对资源做限制。</li></ul></blockquote><ul><li><p>系统负载保护</p><p>Sentinel 同时提供系统维度的自适应保护能力。当系统负载较高的时候，如果还持续让请求进入可能会导致系统崩溃，无法响应。在集群环境下，会把本应这台机器承载的流量转发到其它的机器上去。如果这个时候其它的机器也处在一个边缘状态的时候，Sentinel 提供了对应的保护机制，让系统的入口流量和系统的负载达到一个平衡，保证系统在能力范围之内处理最多的请求。</p></li></ul><p><strong>总之一句话: 我们需要做的事情，就是在Sentinel的资源上配置各种各样的规则，来实现各种容错的功能。</strong></p><h2 id="Sentinel规则"><a href="#Sentinel规则" class="headerlink" title="Sentinel规则"></a>Sentinel规则</h2><h3 id="流控规则"><a href="#流控规则" class="headerlink" title="流控规则"></a>流控规则</h3><p>流量控制，其原理是监控应用流量的QPS(每秒查询率) 或并发线程数等指标，当达到指定的阈值时对流量进行控制，以避免被瞬时的流量高峰冲垮，从而保障应用的高可用性。</p><p>点击簇点链路，我们就可以看到访问过的接口地址，然后点击对应的流控按钮，进入流控规则配置页面。新增流控规则界面如下:</p><p><img src="https://z3.ax1x.com/2021/07/18/W8YBxx.png" srcset="/img/loading.gif" lazyload alt="W8YBxx.png"><a target="_blank" rel="noopener" href="https://imgtu.com/i/W8YBxx">https://imgtu.com/i/W8YBxx</a></p><ul><li><strong>资源名：唯一名称，默认是请求路径，可自定义</strong></li></ul><p><strong>针对来源：指定对哪个微服务进行限流，默认指default，意思是不区分来源，全部限制</strong></p><ul><li><strong>阈值类型&#x2F;单机阈值：</strong><ul><li><strong>QPS（每秒请求数量）: 当调用该接口的QPS达到阈值的时候，进行限流</strong></li><li><strong>线程数：当调用该接口的线程数达到阈值的时候，进行限流</strong></li></ul></li><li><strong>是否集群：暂不需要集群</strong><br>接下来我们以QPS为例来研究限流规则的配置。</li></ul><h4 id="简单配置"><a href="#简单配置" class="headerlink" title="简单配置"></a>简单配置</h4><p>我们先做一个简单配置，设置阈值类型为QPS，单机阈值为3。即每秒请求量大于3的时候开始限流。</p><p>接下来，在流控规则页面就可以看到这个配置。</p><p><img src="https://z3.ax1x.com/2021/07/18/W8YssK.png" srcset="/img/loading.gif" lazyload alt="W8YssK.png"><a target="_blank" rel="noopener" href="https://imgtu.com/i/W8YssK">https://imgtu.com/i/W8YssK</a></p><p>然后快速访问<code>message1</code> 接口，观察效果。此时发现，当QPS &gt; 3的时候，服务就不能正常响应，而是返回Blocked by Sentinel (flow limiting)结果。</p><p><img src="https://z3.ax1x.com/2021/07/18/W8YNa4.png" srcset="/img/loading.gif" lazyload alt="W8YNa4.png"></p><h4 id="配置流控模式"><a href="#配置流控模式" class="headerlink" title="配置流控模式"></a>配置流控模式</h4><p>点击上面设置流控规则的<code>编辑</code>按钮，然后在编辑页面点击<code>高级选项</code>，会看到有流控模式一栏。</p><p><img src="https://z3.ax1x.com/2021/07/18/W8YhRI.png" srcset="/img/loading.gif" lazyload alt="W8YhRI.png"><a target="_blank" rel="noopener" href="https://imgtu.com/i/W8YhRI">https://imgtu.com/i/W8YhRI</a></p><p>sentinel共有三种流控模式，分别是：</p><ul><li>直接（默认）：接口达到限流条件时，开启限流</li><li>关联：当关联的资源达到限流条件时，开启限流 [适合做应用让步]</li><li>链路：当从某个接口过来的资源达到限流条件时，开启限流</li></ul><p>下面呢分别演示三种模式.</p><h5 id="直接流控模式"><a href="#直接流控模式" class="headerlink" title="直接流控模式"></a>直接流控模式</h5><p>直接流控模式是最简单的模式，当指定的接口达到限流条件时开启限流。上面案例使用的就是直接流控模式。</p><h5 id="关联流控模式"><a href="#关联流控模式" class="headerlink" title="关联流控模式"></a>关联流控模式</h5><p>关联流控模式指的是，当指定接口关联的接口达到限流条件时，开启对指定接口开启限流。</p><ul><li>配置限流规则, 将流控模式设置为关联，关联资源设置为的<code>message2</code></li><li>使用jmeter进行压力测试访问，<strong>注意QPS一定要大于0.3，即每秒请求大于等于三次。</strong></li><li>第4步：访问<code>message1</code>,会发现已经被限流</li></ul><p>[<img src="https://z3.ax1x.com/2021/07/18/W8YTL8.png" srcset="/img/loading.gif" lazyload alt="W8YTL8.png"></p><h5 id="链路流控模式"><a href="#链路流控模式" class="headerlink" title="链路流控模式"></a>链路流控模式</h5><p>链路流控模式指的是，当从某个接口过来的资源达到限流条件时，开启限流。它的功能有点类似于针对来源配置项，区别在于：针对来源是针对上级微服务，而链路流控是针对上级接口，也就是说它的粒度更细。</p><ul><li>在<code>OrderService</code>中新建抽象接口</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 打印信息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printMessage</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure><ul><li>在<code>OrderServiceImpl</code>进行实现</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@SentinelResource(&quot;message&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printMessage</span><span class="hljs-params">()</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;OrderService.printMessage&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>在<code>message1</code>、<code>message2</code>中分别增加该调用方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/message1&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">message1</span><span class="hljs-params">()</span> &#123;<br>    orderService.printMessage();<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message1&quot;</span>;<br>&#125;<br><br><span class="hljs-meta">@RequestMapping(&quot;/message2&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">message2</span><span class="hljs-params">()</span> &#123;<br>    orderService.printMessage();<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message2&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>禁止收敛URL的入口 context</li></ul><blockquote><p>从1.6.3 版本开始，Sentinel Web filter默认收敛所有URL的入口context，因此链路限流不生效。<br>1.7.0 版本开始（对应SCA的2.1.1.RELEASE)，官方在CommonFilter 引入了WEB_CONTEXT_UNIFY 参数，用于控制是否收敛context。将其配置为 false 即可根据不同的URL 进行链路限流。SCA 2.1.1.RELEASE之后的版本,可以通过配置spring.cloud.sentinel.web-context-unify&#x3D;false即可关闭收敛</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">sentinel:</span><br>  <span class="hljs-attr">web-context-unify:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterContextConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> FilterRegistrationBean <span class="hljs-title function_">sentinelFilterRegistrationBean</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">FilterRegistrationBean</span> <span class="hljs-variable">registration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterRegistrationBean</span>();<br>        registration.setFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonFilter</span>());<br>        registration.addUrlPatterns(<span class="hljs-string">&quot;/*&quot;</span>);<br>       <span class="hljs-comment">// 入口资源关闭聚合</span><br>        registration.addInitParameter(CommonFilter.WEB_CONTEXT_UNIFY,<span class="hljs-string">&quot;false&quot;</span>);<br>        registration.setName(<span class="hljs-string">&quot;sentinelFilter&quot;</span>);<br>        registration.setOrder(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">return</span> registration;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>控制台配置限流规则</li></ul><p><img src="https://z3.ax1x.com/2021/07/18/W8YzQ0.png" srcset="/img/loading.gif" lazyload alt="W8YzQ0.png"><a target="_blank" rel="noopener" href="https://imgtu.com/i/W8YzQ0">https://imgtu.com/i/W8YzQ0</a></p><ul><li>分别通过<code>message1</code> 和<code>message2</code> 访问, 发现2没问题, 1的被限流了</li></ul><h5 id="配置流控效果"><a href="#配置流控效果" class="headerlink" title="配置流控效果"></a>配置流控效果</h5><ul><li>快速失败（默认）: 直接失败，抛出异常，不做任何额外的处理，是最简单的效果</li><li>Warm Up：它从开始阈值到最大QPS阈值会有一个缓冲阶段，一开始的阈值是最大QPS阈值的1&#x2F;3，然后慢慢增长，直到最大阈值，适用于将突然增大的流量转换为缓步增长的场景。</li><li>排队等待：让请求以均匀的速度通过，单机阈值为每秒通过数量，其余的排队等待； 它还会让设置一个超时时间，当请求超过超时间时间还未处理，则会被丢弃。</li></ul><h4 id="配置降级规则"><a href="#配置降级规则" class="headerlink" title="配置降级规则"></a>配置降级规则</h4><p>降级规则就是设置当满足什么条件的时候，对服务进行降级。Sentinel提供了三个衡量条件：</p><ul><li>平均响应时间 ：当资源的平均响应时间超过阈值（以 ms 为单位）之后，资源进入准降级状态。<br>如果接下来 1s 内持续进入 5 个请求，它们的 RT都持续超过这个阈值，那么在接下的时间窗口（以 s 为单位）之内，就会对这个方法进行服务降级。</li></ul><p><img src="https://z3.ax1x.com/2021/07/18/W8tio4.png" srcset="/img/loading.gif" lazyload alt="W8tio4.png"><a target="_blank" rel="noopener" href="https://imgtu.com/i/W8tio4">https://imgtu.com/i/W8tio4</a></p><blockquote><p>上述配置为当响应时间大于1毫秒的时候，接下来的十秒内该服务进行降级，十秒后回复正常，进行下一轮的判断。</p><p>注意:</p><p>Sentinel 默认统计的 RT 上限是 4900 ms，超出此阈值的都会算作 4900 ms，若需要变更此上限可以通过启动配置项 -Dcsp.sentinel.statistic.max.rt&#x3D;xxx 来配置。</p></blockquote><ul><li><p>异常比例：当资源的每秒异常总数占通过量的比值超过阈值之后，资源进入降级状态，即在接下的时间窗口（以 s 为单位）之内，对这个方法的调用都会自动地返回。异常比率的阈值范围是 [0.0,1.0]。</p><ul><li>模拟一个异常</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">&quot;/message1&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">message1</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">//异常比例为0.33</span><br>    <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message1&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>设置异常比例为0.25</li></ul><p><img src="https://i.bmp.ovh/imgs/2021/09/34f69b017981f9a6.png" srcset="/img/loading.gif" lazyload></p><ul><li>异常数 ：当资源近 1 分钟的异常数目超过阈值之后会进行服务降级。注意由于统计时间窗口是分钟级别的，若时间窗口小于 60s，则结束熔断状态后仍可能再进入熔断状态。</li></ul></li></ul><p><img src="https://i.bmp.ovh/imgs/2021/09/14bfdc57aeca8152.png" srcset="/img/loading.gif" lazyload></p><blockquote><p>问题：<br>流控规则和降级规则返回的异常页面是一样的，我们怎么来区分到底是什么原因导致的呢？</p></blockquote><h4 id="配置热点规则"><a href="#配置热点规则" class="headerlink" title="配置热点规则"></a>配置热点规则</h4><p>热点参数流控规则是一种更细粒度的流控规则, 它允许将规则具体到参数上。</p><h5 id="简单配置-1"><a href="#简单配置-1" class="headerlink" title="简单配置"></a>简单配置</h5><ul><li><p>编写代码</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">&quot;/message3&quot;</span>)<br><span class="hljs-variable">@SentinelResource</span>(<span class="hljs-string">&quot;messages3&quot;</span>)<span class="hljs-comment">//注意这里必须使用这个注解标识,热点规则不生效</span><br>public String <span class="hljs-built_in">message3</span>(String name,Integer age) &#123;<br>    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">name</span> + <span class="hljs-selector-tag">age</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>配置热点规则</p></li></ul><p><img src="https://i.loli.net/2021/09/05/ySYaLxKuJf9sDOU.png" srcset="/img/loading.gif" lazyload alt="image-20210905201210835"></p><ul><li>分别用两个参数访问,会发现只对第一个参数限流了</li></ul><h5 id="热点规则增强使用"><a href="#热点规则增强使用" class="headerlink" title="热点规则增强使用"></a>热点规则增强使用</h5><p>参数例外项允许对一个参数的具体值进行流控</p><ul><li>编辑刚才定义的规则,增加参数例外项</li></ul><p><img src="https://i.bmp.ovh/imgs/2021/09/0d1b9c0cae07396d.png" srcset="/img/loading.gif" lazyload></p><h3 id="授权规则"><a href="#授权规则" class="headerlink" title="授权规则"></a>授权规则</h3><p>很多时候，我们需要根据调用来源来判断该次请求是否允许放行，这时候可以使用 Sentinel 的来源<br>访问控制的功能。来源访问控制根据资源的请求来源（origin）限制资源是否通过：</p><ul><li>若配置白名单，则只有请求来源位于白名单内时才可通过；</li><li>若配置黑名单，则请求来源位于黑名单时不通过，其余的请求通过。</li></ul><p><img src="https://i.bmp.ovh/imgs/2021/09/94bc40c52a38bde8.png" srcset="/img/loading.gif" lazyload></p><p>上面的资源名和授权类型不难理解，但是流控应用怎么填写呢？</p><blockquote><p>其实这个位置要填写的是来源标识，Sentinel提供了<code>RequestOriginParser</code>接口来处理来源。</p><p>只要Sentinel保护的接口资源被访问，Sentinel就会调用RequestOriginParser的实现类去解析访问来源。</p><p>下方有坑，请注意！！！！</p><hr><p><strong>&#x3D;&#x3D;注意：由于上方配置流控规则是把收敛的接口都开放了，博猪在实现<code>RequestOriginParser</code>接口处理来源，配置黑白名单时不生效，这个具体原因博猪还没进一步查看源码实现逻辑，可能是sentinel的一个bug，所以需要把注入的<code>FilterRegistrationBean</code>去掉，配置文件中的<code>WEB_CONTEXT_UNIFY ​</code>去掉！！&#x3D;&#x3D;</strong></p></blockquote><h4 id="自定义处理规则"><a href="#自定义处理规则" class="headerlink" title="自定义处理规则"></a>自定义处理规则</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceNameOriginParser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RequestOriginParser</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">parseOrigin</span>(<span class="hljs-params">HttpServletRequest httpServletRequest</span>) &#123;<br>        <span class="hljs-title class_">String</span> serviceName = httpServletRequest.<span class="hljs-title function_">getParameter</span>(<span class="hljs-string">&quot;serviceName&quot;</span>);<br>        <span class="hljs-keyword">return</span> serviceName;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="配置授权规则"><a href="#配置授权规则" class="headerlink" title="配置授权规则"></a>配置授权规则</h4><blockquote><p>解释一下配置含义：当seriviceName&#x3D;pc时不能访问（黑名单）</p></blockquote><p><img src="https://i.bmp.ovh/imgs/2021/09/ad32eb08f12b3954.png" srcset="/img/loading.gif" lazyload></p><h4 id="访问配置地址，查看结果"><a href="#访问配置地址，查看结果" class="headerlink" title="访问配置地址，查看结果"></a>访问配置地址，查看结果</h4><p>访问<a target="_blank" rel="noopener" href="http://localhost:8091/highConcurrency/getMessage?serviceName=pc%EF%BC%8C%E6%9F%A5%E7%9C%8B%E7%BB%93%E6%9E%9C">http://localhost:8091/highConcurrency/getMessage?serviceName=pc，查看结果</a></p><h3 id="系统规则"><a href="#系统规则" class="headerlink" title="系统规则"></a>系统规则</h3><p>系统保护规则是从应用级别的入口流量进行控制，从单台机器的总体 Load、RT、入口 QPS 、CPU使用率和线程数五个维度监控应用数据，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p><p>系统保护规则是应用整体维度的，而不是资源维度的，并且仅对入口流量 (进入应用的流量) 生效。</p><ul><li>Load（仅对 Linux&#x2F;Unix-like 机器生效）：当系统 load1 超过阈值，且系统当前的并发线程数超过系统容量时才会触发系统保护。系统容量由系统的 maxQps * minRt 计算得出。设定参考值一般是 CPU cores * 2.5。</li><li>RT：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li><li>线程数：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li><li>入口 QPS：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</li><li>CPU使用率：当单台机器上所有入口流量的 CPU使用率达到阈值即触发系统保护。</li></ul><h3 id="拓展-自定义异常返回"><a href="#拓展-自定义异常返回" class="headerlink" title="拓展-自定义异常返回"></a>拓展-自定义异常返回</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SentinelExceptionHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BlockExceptionHandler</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * BlockException 异常接口,包含Sentinel的五个异常</span><br><span class="hljs-comment">     * FlowException          限流异常</span><br><span class="hljs-comment">     * DegradeException       降级异常</span><br><span class="hljs-comment">     * ParamFlowException     参数限流异常</span><br><span class="hljs-comment">     * AuthorityException     授权异常</span><br><span class="hljs-comment">     * SystemBlockException   系统负载异常</span><br><span class="hljs-comment">     * */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, BlockException e)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        response.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);<br>        <span class="hljs-type">ResponseData</span> <span class="hljs-variable">responseData</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> FlowException) &#123;<br>            responseData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseData</span>(<span class="hljs-number">4001</span>, <span class="hljs-string">&quot;接口被限流！&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> DegradeException) &#123;<br>            responseData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseData</span>(<span class="hljs-number">4002</span>, <span class="hljs-string">&quot;接口被降级！&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> ParamFlowException) &#123;<br>            responseData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseData</span>(<span class="hljs-number">4003</span>, <span class="hljs-string">&quot;接口参数被限流！&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> AuthorityException) &#123;<br>            responseData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseData</span>(<span class="hljs-number">4004</span>, <span class="hljs-string">&quot;接口授权异常！&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> SystemBlockException) &#123;<br>            responseData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseData</span>(<span class="hljs-number">4005</span>, <span class="hljs-string">&quot;系统负载异常！&quot;</span>);<br>        &#125;<br>        response.getWriter().write(JSONObject.toJSONString(responseData));<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 返回类定义</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponseData</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;<br>    <span class="hljs-keyword">private</span> String message;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/09/05/gbKIefCR5xQZNTW.png" srcset="/img/loading.gif" lazyload alt="image.png"></p><h2 id="Sentinel注解"><a href="#Sentinel注解" class="headerlink" title="Sentinel注解"></a>Sentinel注解</h2><h3 id="SentinelResource"><a href="#SentinelResource" class="headerlink" title="SentinelResource"></a>SentinelResource</h3><p>在定义了资源点之后，我们可以通过Dashboard来设置限流和降级策略来对资源点进行保护。同时还能通过<code>@SentinelResource</code>来指定出现异常时的处理策略。<code>@SentinelResource</code> 用于定义资源，并提供可选的异常处理和 fallback 配置项。其主要参数如下:</p><table><thead><tr><th><strong>属性</strong></th><th>作用</th></tr></thead><tbody><tr><td>value</td><td>资源名称</td></tr><tr><td>entryType</td><td>entry类型，标记流量的方向，取值<code>IN/OUT</code>，默认是OUT</td></tr><tr><td>blockHandler</td><td>处理BlockException的函数名称,函数要求：<br>1.必须是 public<br>2. 返回类型 参数与原方法一致<br>3.默认需和原方法在同一个类中。若希望使用其他类的函数，可配置<code>blockHandlerClass</code>，并指定<code>blockHandlerClass</code>里面的方法。</td></tr><tr><td>blockHandlerClass</td><td>存放fallback的类。对应的处理函数必须static修饰。</td></tr><tr><td>fallback</td><td>用于在抛出异常的时候提供fallback处理逻辑。<br>fallback函数可以针对所有类型的异常（除了 exceptionsToIgnore 里面排除掉的异常类型）进行处理。<br>函数要求：<br>1. 返回类型与原方法一致<br>2. 参数类型需要和原方法相匹配<br>3. 默认需和原方法在同一个类中。若希望使用其他类的函数，可配置fallbackClass ，并指定fallbackClass里面的方法。</td></tr><tr><td>fallbackClass</td><td>存放fallback的类。对应的处理函数必须static修饰。</td></tr><tr><td>defaultFallback</td><td>用于通用的 fallback 逻辑。<br>默认fallback函数可以针对所有类型的异常进行处理。若同时配置了 fallback 和 defaultFallback，以fallback为准。<br>函数要求：<br>1. 返回类型与原方法一致<br>2. 方法参数列表为空，或者有一个 Throwable 类型的参数。<br>3.默认需要和原方法在同一个类中。若希望使用其他类的函数，可配置fallbackClass ，并指定 fallbackClass 里面的方法。</td></tr><tr><td>exceptionsToIgnore</td><td>指定排除掉哪些异常。排除的异常不会计入异常统计，也不会进入fallback逻辑，而是原样抛出。</td></tr><tr><td>exceptionsToTrace</td><td>需要trace的异常</td></tr></tbody></table><p>下面通过代码案例演示</p><h4 id="限流降级定义在同一个类里面"><a href="#限流降级定义在同一个类里面" class="headerlink" title="限流降级定义在同一个类里面"></a>限流降级定义在同一个类里面</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> SentinelResource&#125;</span><br><span class="hljs-comment"> *  value：资源名称</span><br><span class="hljs-comment"> *  blockHandler：sentinel异常捕获信息</span><br><span class="hljs-comment"> *  fallback：业务异常（除sentinel异常之外的）的异常捕获信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SentinelResource(value = &quot;message4&quot;, blockHandler = &quot;message4BlockHandler&quot;, fallback = &quot;message4Fallback&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/message4&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">message4</span><span class="hljs-params">()</span> &#123;<br>    ERROR_COUNT++;<br>    <span class="hljs-keyword">if</span> (ERROR_COUNT % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message4&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">message4BlockHandler</span><span class="hljs-params">(BlockException e)</span> &#123;<br>    log.error(<span class="hljs-string">&quot;message4 接口被限流或者被降级了!,exception info is:&quot;</span>, e);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message4 接口被限流或者被降级了!&quot;</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">message4Fallback</span><span class="hljs-params">(Throwable e)</span> &#123;<br>    log.error(<span class="hljs-string">&quot;message4 接口异常!,throwable info is:&quot;</span>, e);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message4 接口异常!&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>运行</li><li>增加流程规则，简单设置个QPS限制</li><li>请求接口，测试。</li></ul><blockquote><p>通过请求接口我们发现，throw出来的RuntimeException打印和返回的是<code>message4Fallback</code>的信息，sentinel的QPS的异常信息打印和返回是<code>message4BlockHandler</code>.</p><ul><li><strong>&#x3D;&#x3D;注意blockHandler里面的方法名一定要和实现异常处理的方法名一致，且返回类型一致！&#x3D;&#x3D;</strong></li><li><strong>&#x3D;&#x3D;注意sentinel的<code>SentinelResource</code>的两个属性的实现方法是可以使用参数的，但是必须包含异常信息的参数，并且，blockHandler的异常只能是<code>BlockException</code>,其他类型则会自动进入<code>fallback</code>里面&#x3D;&#x3D;</strong></li><li><code>SentinelResource</code>的异常高于自定义全局异常捕获机智！</li></ul></blockquote><h3 id="将限流降级放在单独的类里面"><a href="#将限流降级放在单独的类里面" class="headerlink" title="将限流降级放在单独的类里面"></a>将限流降级放在单独的类里面</h3><h4 id="抽取限流方法"><a href="#抽取限流方法" class="headerlink" title="抽取限流方法"></a>抽取限流方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HighConcurrencyBlockHandler</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">message4BlockHandler</span><span class="hljs-params">(BlockException e)</span> &#123;<br>        log.error(<span class="hljs-string">&quot;message4 接口被限流或者被降级了,HighConcurrencyBlockHandler!,exception info is:&quot;</span>, e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message4 接口被限流或者被降级了,HighConcurrencyBlockHandler!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="抽取fallback方法"><a href="#抽取fallback方法" class="headerlink" title="抽取fallback方法"></a>抽取fallback方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HighConcurrencyFallback</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">message4Fallback</span><span class="hljs-params">(Throwable e)</span> &#123;<br>        log.error(<span class="hljs-string">&quot;message4 接口异常,HighConcurrencyFallback!,throwable info is:&quot;</span>, e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message4 接口异常,HighConcurrencyFallback!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="改造资源保护方法"><a href="#改造资源保护方法" class="headerlink" title="改造资源保护方法"></a>改造资源保护方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * &#123;<span class="hljs-doctag">@link</span> SentinelResource&#125;</span><br><span class="hljs-comment">  * value：资源名称</span><br><span class="hljs-comment">  * blockHandler：sentinel异常捕获信息</span><br><span class="hljs-comment">  * fallback：业务异常（除sentinel异常之外的）的异常捕获信息</span><br><span class="hljs-comment">  *</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br> <span class="hljs-meta">@SentinelResource(value = &quot;message4&quot;,</span><br><span class="hljs-meta">         blockHandler = &quot;message4BlockHandler&quot;, fallback = &quot;message4Fallback&quot;,</span><br><span class="hljs-meta">         blockHandlerClass = HighConcurrencyBlockHandler.class, fallbackClass = HighConcurrencyFallback.class)</span><br> <span class="hljs-meta">@GetMapping(&quot;/message4&quot;)</span><br> <span class="hljs-keyword">public</span> String <span class="hljs-title function_">message4</span><span class="hljs-params">()</span> &#123;<br>     ERROR_COUNT++;<br>     <span class="hljs-keyword">if</span> (ERROR_COUNT % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) &#123;<br>         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>();<br>     &#125; <span class="hljs-keyword">else</span> &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message4&quot;</span>;<br>     &#125;<br> &#125;<br></code></pre></td></tr></table></figure><ul><li>运行</li><li>增加流程规则，简单设置个QPS限制</li><li>请求接口，测试。</li></ul><h2 id="Sentinel规则持久化"><a href="#Sentinel规则持久化" class="headerlink" title="Sentinel规则持久化"></a>Sentinel规则持久化</h2><p>通过前面的讲解，我们已经知道，可以通过Dashboard来为每个Sentinel客户端设置各种各样的规则，但是这里有一个问题，就是这些规则默认是存放在内存中，极不稳定，所以需要将其持久化。</p><p>本地文件数据源会定时轮询文件的变更，读取规则。这样我们既可以在应用本地直接修改文件来更新规则，也可以通过 Sentinel 控制台推送规则。以本地文件数据源为例，推送过程如下图所示：</p><p><img src="https://i.bmp.ovh/imgs/2021/09/cd5c368316e6c777.png" srcset="/img/loading.gif" lazyload></p><p>首先 Sentinel 控制台通过 API 将规则推送至客户端并更新到内存中，接着注册的写数据源会将新的规则保存到本地的文件中。</p><h3 id="实现实例化功能"><a href="#实现实例化功能" class="headerlink" title="实现实例化功能"></a>实现实例化功能</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> SentinelPersistence</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> Sentitnel持久化</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> will</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/9/12 14:04</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SentinelPersistence</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitFunc</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">ruleDir</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.home&quot;</span>) + <span class="hljs-string">&quot;/sentinel-rules/&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">flowRulePath</span> <span class="hljs-operator">=</span> ruleDir + <span class="hljs-string">&quot;/flow-rule.json&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">degradeRulePath</span> <span class="hljs-operator">=</span> ruleDir + <span class="hljs-string">&quot;/degrade-rule.json&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">systemRulePath</span> <span class="hljs-operator">=</span> ruleDir + <span class="hljs-string">&quot;/system-rule.json&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">authorityRulePath</span> <span class="hljs-operator">=</span> ruleDir + <span class="hljs-string">&quot;/authority-rule.json&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">paramFlowRulePath</span> <span class="hljs-operator">=</span> ruleDir + <span class="hljs-string">&quot;/param-flow-rule.json&quot;</span>;<br><br>        <span class="hljs-built_in">this</span>.mkdir(ruleDir);<br>        <span class="hljs-built_in">this</span>.createFile(flowRulePath);<br>        <span class="hljs-built_in">this</span>.createFile(degradeRulePath);<br>        <span class="hljs-built_in">this</span>.createFile(systemRulePath);<br>        <span class="hljs-built_in">this</span>.createFile(authorityRulePath);<br>        <span class="hljs-built_in">this</span>.createFile(paramFlowRulePath);<br><br>        <span class="hljs-comment">// 流控规则</span><br>        ReadableDataSource&lt;String, List&lt;FlowRule&gt;&gt; flowRuleRDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileRefreshableDataSource</span>&lt;&gt;(<br>                flowRulePath,<br>                flowRuleListParser<br>        );<br>        FlowRuleManager.register2Property(flowRuleRDS.getProperty());<br>        WritableDataSource&lt;List&lt;FlowRule&gt;&gt; flowRuleWDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWritableDataSource</span>&lt;&gt;(<br>                flowRulePath,<br>                <span class="hljs-built_in">this</span>::encodeJson<br>        );<br>        WritableDataSourceRegistry.registerFlowDataSource(flowRuleWDS);<br><br>        <span class="hljs-comment">// 降级规则</span><br>        ReadableDataSource&lt;String, List&lt;DegradeRule&gt;&gt; degradeRuleRDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileRefreshableDataSource</span>&lt;&gt;(<br>                degradeRulePath,<br>                degradeRuleListParser<br>        );<br>        DegradeRuleManager.register2Property(degradeRuleRDS.getProperty());<br>        WritableDataSource&lt;List&lt;DegradeRule&gt;&gt; degradeRuleWDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWritableDataSource</span>&lt;&gt;(<br>                degradeRulePath,<br>                <span class="hljs-built_in">this</span>::encodeJson<br>        );<br>        WritableDataSourceRegistry.registerDegradeDataSource(degradeRuleWDS);<br><br>        <span class="hljs-comment">// 系统规则</span><br>        ReadableDataSource&lt;String, List&lt;SystemRule&gt;&gt; systemRuleRDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileRefreshableDataSource</span>&lt;&gt;(<br>                systemRulePath,<br>                systemRuleListParser<br>        );<br>        SystemRuleManager.register2Property(systemRuleRDS.getProperty());<br>        WritableDataSource&lt;List&lt;SystemRule&gt;&gt; systemRuleWDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWritableDataSource</span>&lt;&gt;(<br>                systemRulePath,<br>                <span class="hljs-built_in">this</span>::encodeJson<br>        );<br>        WritableDataSourceRegistry.registerSystemDataSource(systemRuleWDS);<br><br>        <span class="hljs-comment">// 授权规则</span><br>        ReadableDataSource&lt;String, List&lt;AuthorityRule&gt;&gt; authorityRuleRDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileRefreshableDataSource</span>&lt;&gt;(<br>                authorityRulePath,<br>                authorityRuleListParser<br>        );<br>        AuthorityRuleManager.register2Property(authorityRuleRDS.getProperty());<br>        WritableDataSource&lt;List&lt;AuthorityRule&gt;&gt; authorityRuleWDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWritableDataSource</span>&lt;&gt;(<br>                authorityRulePath,<br>                <span class="hljs-built_in">this</span>::encodeJson<br>        );<br>        WritableDataSourceRegistry.registerAuthorityDataSource(authorityRuleWDS);<br><br>        <span class="hljs-comment">// 热点参数规则</span><br>        ReadableDataSource&lt;String, List&lt;ParamFlowRule&gt;&gt; paramFlowRuleRDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileRefreshableDataSource</span>&lt;&gt;(<br>                paramFlowRulePath,<br>                paramFlowRuleListParser<br>        );<br>        ParamFlowRuleManager.register2Property(paramFlowRuleRDS.getProperty());<br>        WritableDataSource&lt;List&lt;ParamFlowRule&gt;&gt; paramFlowRuleWDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWritableDataSource</span>&lt;&gt;(<br>                paramFlowRulePath,<br>                <span class="hljs-built_in">this</span>::encodeJson<br>        );<br>        ModifyParamFlowRulesCommandHandler.setWritableDataSource(paramFlowRuleWDS);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Converter&lt;String, List&lt;FlowRule&gt;&gt; flowRuleListParser = source -&gt; JSON.parseObject(<br>            source,<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;FlowRule&gt;&gt;() &#123;<br>            &#125;<br>    );<br>    <span class="hljs-keyword">private</span> Converter&lt;String, List&lt;DegradeRule&gt;&gt; degradeRuleListParser = source -&gt; JSON.parseObject(<br>            source,<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;DegradeRule&gt;&gt;() &#123;<br>            &#125;<br>    );<br>    <span class="hljs-keyword">private</span> Converter&lt;String, List&lt;SystemRule&gt;&gt; systemRuleListParser = source -&gt; JSON.parseObject(<br>            source,<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;SystemRule&gt;&gt;() &#123;<br>            &#125;<br>    );<br><br>    <span class="hljs-keyword">private</span> Converter&lt;String, List&lt;AuthorityRule&gt;&gt; authorityRuleListParser = source -&gt; JSON.parseObject(<br>            source,<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;AuthorityRule&gt;&gt;() &#123;<br>            &#125;<br>    );<br><br>    <span class="hljs-keyword">private</span> Converter&lt;String, List&lt;ParamFlowRule&gt;&gt; paramFlowRuleListParser = source -&gt; JSON.parseObject(<br>            source,<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;ParamFlowRule&gt;&gt;() &#123;<br>            &#125;<br>    );<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建文件夹，不存在则创建</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filePath   文件路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mkdir</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filePath);<br>        <span class="hljs-keyword">if</span> (!file.exists()) &#123;<br>            file.mkdirs();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建文件，不存在则创建</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filePath    文件路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createFile</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filePath);<br>        <span class="hljs-keyword">if</span> (!file.exists()) &#123;<br>            file.createNewFile();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> &lt;T&gt; String <span class="hljs-title function_">encodeJson</span><span class="hljs-params">(T t)</span> &#123;<br>        <span class="hljs-keyword">return</span> JSONObject.toJSONString(t);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="添加配置-1"><a href="#添加配置-1" class="headerlink" title="添加配置"></a>添加配置</h3><ul><li>在<code>resource</code>下面创建配置目录<code>META-INF/services ​</code></li><li>添加文件<code>com.alibaba.csp.sentinel.init.InitFunc</code></li><li>在文件中添加配置类的全路径</li></ul><blockquote><p><strong>&#x3D;&#x3D;该实例化存在一个严重的问题，我为了这个配置类的易用性，增加注入了一个spring的<code>spring.application.name</code>,但是不知道为啥，项目启动后改配置读取不到，显示为null,后经过debug发现的sentinel相关默认实现添加了spring的order排序，但是博猪更改排序后还是无效，这个疑问还请有踩过坑的，麻烦解读一下&#x3D;&#x3D;</strong></p></blockquote><h2 id="Feign整合Sentinel"><a href="#Feign整合Sentinel" class="headerlink" title="Feign整合Sentinel"></a>Feign整合Sentinel</h2><h3 id="引入sentinel的依赖"><a href="#引入sentinel的依赖" class="headerlink" title="引入sentinel的依赖"></a>引入sentinel的依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--sentinel客户端--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="配置开启feign"><a href="#配置开启feign" class="headerlink" title="配置开启feign"></a>配置开启feign</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">sentinel:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h3 id="创建产品feign-api项目"><a href="#创建产品feign-api项目" class="headerlink" title="创建产品feign-api项目"></a>创建产品feign-api项目</h3><h4 id="创建shop-product-api模块，jar包形式"><a href="#创建shop-product-api模块，jar包形式" class="headerlink" title="创建shop-product-api模块，jar包形式"></a>创建<code>shop-product-api</code>模块，jar包形式</h4><h4 id="增加相关依赖"><a href="#增加相关依赖" class="headerlink" title="增加相关依赖"></a>增加相关依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--fegin组件--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="创建feignClient"><a href="#创建feignClient" class="headerlink" title="创建feignClient"></a>创建feignClient</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> ProductFeignClient</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> will</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/7/11 18:25</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@FeignClient(name = &quot;shop-product&quot;</span><br><span class="hljs-meta">        , fallback = ProductFeignClientFallback.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProductFeignClient</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_FALLBACK_MSG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;服务不可用！&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据产品id查询产品详情</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> productId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/api/queryProductInfoByProductId/&#123;productId&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> ProductVO <span class="hljs-title function_">queryProductInfoByProductId</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Integer productId)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="创建fallback"><a href="#创建fallback" class="headerlink" title="创建fallback"></a>创建fallback</h4><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> ProductFeignClientFallback</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> will</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/7/11 18:29</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf</span>4j<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProductFeignClientFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ProductFeignClient</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function">ProductVO <span class="hljs-title">queryProductInfoByProductId</span><span class="hljs-params">(Integer productId)</span> </span>&#123;<br>        log.<span class="hljs-keyword">error</span>(DEFAULT_FALLBACK_MSG);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="创建feignClientVO"><a href="#创建feignClientVO" class="headerlink" title="创建feignClientVO"></a>创建feignClientVO</h4><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs zephir"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> ProductVO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> will</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/7/11 18:33</span><br><span class="hljs-comment"> */</span><br>@Data<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProductVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">1</span>L;<br><br>   <span class="hljs-comment">/** 主键 */</span><br>   <span class="hljs-keyword">private</span> Integer pId;<br>   <span class="hljs-comment">/** 商品名称 */</span><br>   <span class="hljs-keyword">private</span> String pName;<br>   <span class="hljs-comment">/** 商品价格 */</span><br>   <span class="hljs-keyword">private</span> Double pPrice;<br>   <span class="hljs-comment">/** 库存 */</span><br>   <span class="hljs-keyword">private</span> Integer stock;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="产品服务增加相关依赖"><a href="#产品服务增加相关依赖" class="headerlink" title="产品服务增加相关依赖"></a>产品服务增加相关依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.letcoding<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shop-product-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="修改订单服务"><a href="#修改订单服务" class="headerlink" title="修改订单服务"></a>修改订单服务</h3><h4 id="订单服务开启feign，修改订单启动类"><a href="#订单服务开启feign，修改订单启动类" class="headerlink" title="订单服务开启feign，修改订单启动类"></a>订单服务开启feign，修改订单启动类</h4><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @ClassName OrderApplication</span><br><span class="hljs-comment"> * @Description</span><br><span class="hljs-comment"> * @Author will</span><br><span class="hljs-comment"> * @Date 2021/6/20 19:32</span><br><span class="hljs-comment"> */</span><br><span class="hljs-variable">@SpringBootApplication</span><br><span class="hljs-variable">@EnableDiscoveryClient</span><br><span class="hljs-variable">@ComponentScan</span>(basePackages = &#123;<span class="hljs-string">&quot;com.letcoding.order&quot;</span>,<span class="hljs-string">&quot;com.letcoding.product&quot;</span>&#125;)<br><span class="hljs-variable">@EnableFeignClients</span>(basePackages = <span class="hljs-string">&quot;com.letcoding.product&quot;</span>)<br>public class OrderApplication &#123;<br>    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) &#123;<br>        <span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(OrderApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="启动测试"><a href="#启动测试" class="headerlink" title="启动测试"></a>启动测试</h3><ul><li>启动产品服务、订单服务，创建订单试一下</li><li>停止订单服务，再次下订单</li></ul><blockquote><p>&#x3D;&#x3D;简单说明一下，个人对于feign编码的习惯，还是遵循低耦合的原则，尽量不适用公共的vo等，同时尽量精简定义feign的相关对象，提供http的传输效率，因为feign的底层也是http请求，所以过大的请求和各服务之间的相互调用，对于feign这一块还是要注意的！&#x3D;&#x3D;</p><p>通过测试，我们发现，该方式请求不会正确的抛出异常来，所以如果想知道具体的fallback异常，请使用一下形式进行。</p></blockquote><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> ProductFeignClientFallbackFactory</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> will</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/9/12 21:42</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf</span>4j<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProductFeignClientFallbackFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FallbackFactory</span>&lt;<span class="hljs-title">ProductFeignClient</span>&gt; </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function">ProductFeignClient <span class="hljs-title">create</span><span class="hljs-params">(Throwable cause)</span> </span>&#123;<br>        log.<span class="hljs-keyword">error</span>(<span class="hljs-string">&quot;FallbackFactory,服务不可用！&quot;</span>,cause);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> ProductFeignClient</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> will</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/7/11 18:25</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@FeignClient(name = &quot;shop-product&quot;</span><br><span class="hljs-meta">//        , fallback = ProductFeignClientFallback.class</span><br><span class="hljs-meta">        , fallbackFactory = ProductFeignClientFallbackFactory.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProductFeignClient</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_FALLBACK_MSG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;服务不可用！&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据产品id查询产品详情</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> productId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/api/queryProductInfoByProductId/&#123;productId&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> ProductVO <span class="hljs-title function_">queryProductInfoByProductId</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Integer productId)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>&#x3D;&#x3D;注意: fallback和fallbackFactory只能使用其中一种方式&#x3D;&#x3D;</p></blockquote></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/" class="category-chain-item">好好码代码吖</a> <span>></span> <a href="/categories/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/JAVA/" class="category-chain-item">JAVA</a> <span>></span> <a href="/categories/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/JAVA/Spring/" class="category-chain-item">Spring</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/JAVA/">#JAVA</a> <a href="/tags/Spring/">#Spring</a> <a href="/tags/SpringCloud/">#SpringCloud</a> <a href="/tags/SpringCloud-Alibaba/">#SpringCloud Alibaba</a></div></div><div class="license-box my-3"><div class="license-title"><div>Spring-Cloud-Alibaba(4)-服务容错</div><div>https://github.com/yangxiangnanwill/yangxiangnanwill.github.io/2023/05/28/好好码代码吖/JAVA/Spring/Spring-Cloud-Alibaba(4)-服务容错/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>will</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年5月28日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/05/28/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/JAVA/Spring/Spring-Cloud-Alibaba(6)-%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/" title="Spring-Cloud-Alibaba(6)-链路追踪"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Spring-Cloud-Alibaba(6)-链路追踪</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/05/28/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/JAVA/Spring/Spring-Cloud-Alibaba(3)-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/" title="Spring-Cloud-Alibaba(3)-服务治理"><span class="hidden-mobile">Spring-Cloud-Alibaba(3)-服务治理</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing;(t=t.getElementById("subtitle"))&&e&&e(t.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){var t;"tocbot"in window&&(tocbot.refresh(),0!==(t=jQuery("#toc")).length)&&tocbot&&0<t.find(".toc-list-item").length&&t.css("visibility","visible")}))})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback(function(){if("anchors"in window){anchors.removeAll();var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}})})</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>